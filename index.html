<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munetios OmniWrite</title>
    <link rel="stylesheet" href="https://api.munetios.com/beautiful-css/beautiful.css">
    <meta name="url" content="https://write.munetios.com">
    <meta name="description" content="A powerful and intuitive writing tool by Munetios.">
    <meta name="keywords" content="writing, tool, Munetios, OmniWrite, text editor">
    <meta name="author" content="Munetios">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').catch(function(e){
            console.error('Service Worker registration failed:', e);
        });
    });
}
</script>
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
     style-src 'self' https://fonts.googleapis.com https://api.munetios.com 'unsafe-inline';
      font-src 'self' https://fonts.gstatic.com;
    script-src 'self' https://cdnjs.cloudflare.com 'nonce-erjntgeryfheusjfhbdffeshF34YUH34yuhfuew8ufh34uidIRFEh3ui';
       media-src 'self' blob: data:;  img-src 'self' https: data: blob:; connect-src 'self';
        frame-src 'self' https://www.munetios.com https://calendar.munetios.com;
        ">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght,ROND@6..144,1..1000,90&display=swap');
        html, button, input, select, textarea {
            font-family: 'Google Sans Flex', sans-serif;
            box-sizing: border-box;
        }
        body {
            font-family: 'Google Sans Flex', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #110736;
            box-sizing: border-box;
            color: #FFFFFF;
        }
        h1, h2, h3, h4, h5, h6 {
            font-variation-settings: 'ROND' 90;
        }
        p {
                     font-variation-settings: 'ROND' 60 !important;
        }
        .app {
            display: flex;
            height: 100vh;
            box-sizing: border-box;
        }
        .sidebar__container {
            width: 300px;
            box-sizing: border-box;
        }
        .sidenav {
            height: 100%;
            box-sizing: border-box;
        }
        .sidebar {
            height: 100%;
            box-sizing: border-box;
            border-radius: 16px;
            scrollbar-width: none;
            overflow-y: auto;
        }
        .sidebar__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            box-sizing: border-box;
        }
        .sidebar__header h3 {
            margin: 0;
            font-size: 24px;
        }
        .sidebarnav__items {
            display: flex;
            flex-direction: column;
            padding: 8px 0;
            box-sizing: border-box;
        }
        .sidebarnav__item {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            box-sizing: border-box;
        }
        .sidebarnav__item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        #createBtn {
            cursor: pointer;
            border-radius: 69px;
            padding: 8px;
        }
        #createBtn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        icon {
            font-family: 'Material Symbols Rounded';
            font-size: 28px
        }
        .sidebar__content {
            padding: 0 8px;
            overflow-y: auto;
            min-height: 200px;
            box-sizing: border-box;
            scrollbar-width: none; /* Chrome, Edge, Firefox, Opera, Brave */
            -ms-overflow-style: none;  /* IE and Edge Legacy */
            height: calc(100% - 470px);
        }
        .sidebar__content::-webkit-scrollbar {
            display: none; /* Safari */
        }
        .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            margin: 16px 0;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .search-bar input {
            width: 100%;
            padding: 8px;
            border: none;
            outline: none;
            border-radius: 8px;
            color: #FFFFFF;
            background-color: transparent;
            font-size: 16px;
            box-sizing: border-box;
        }
        .sidebar__bottom {
            box-sizing: border-box;
        }
        .dropdown-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100000000;
            height: auto;
            width: auto;
            white-space: nowrap;
            max-height: 500px;
            overflow-y: auto;
            scrollbar-width: none; /* Chrome, Edge, Firefox, Opera, Brave */
            margin: 60px 0 0 20px;
            border-radius: 16px;
            box-sizing: border-box;
            display: none;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            cursor: pointer;
            box-sizing: border-box;
        }
        .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .main-container {
            width: calc(100% - 300px);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            margin-left: 10px;
            margin-top: 10px;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .navbar-container {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        .navbar {
            display: flex;
            align-items: center;
            box-sizing: border-box;
            justify-content: space-between;
            position: fixed;
            width: calc(100% - 320px);
            padding: 0 12px;
            top: 10px;
            z-index: 999;
        }
        .menu-btn {
            cursor: pointer;
            border-radius: 69px;
            padding: 10px 13px;
            display: flex;
            justify-content: center;

        }
        .menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
            transform: scale(1.3);
        }
        .content-area {
            margin-top: 60px;
            padding: 20px;
            box-sizing: border-box;
            height: calc(100vh - 80px);
        }
        .select-area {
            text-align: center;
            margin-top: 100px;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .navbar__right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .navbar__left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .modal-content {
            background-color: #ffffff10;
            border: 1px solid #ffffff20;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 16px;
            box-sizing: border-box;
            width: 90%;
            max-width: 700px;
            max-height: 80%;
            overflow-y: auto;
        }
        .modal-content-close {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
        }
        button {
            cursor: pointer;
            outline: none;
            padding: 10px 16px;
               background:
    linear-gradient(
      to bottom,
      rgba(255,255,255,0.16) 0%,
      rgba(255,255,255,0.06) 22%,
      rgba(255,255,255,0.04) 50%,
      rgba(255,255,255,0.06) 78%,
      rgba(255,255,255,0.14) 100%
    );
    box-shadow: 0 8px 32px 0 rgba( 31, 38, 135, 0.37 );
    backdrop-filter: blur( 1.75px )  saturate(180%) brightness(105%) contrast(100%);
    -webkit-backdrop-filter: blur( 1.75px )  saturate(200%) brightness(125%) contrast(100%);
    border-radius: 50px;
    border: 1px solid rgba(255, 255, 255, 0.18);
            color: #FFFFFF;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        @media (max-width: 1050px) {
            .sidebar__container {
               left: -600px;
               position: fixed;
            }
            .main-container {
                width: 100%;
                margin-left: 0;
            }
            .navbar {
                width: 100%;
                padding: 0 20px;
            }
        }
        @media (max-width: 375px) {
            .create-text {
                display: none;
            }
        }
        /* Sidebar slide-in/out animation */
        @keyframes sidebarSlideIn {
            from { left: -600px; opacity: 0; }
            to { left: 0; opacity: 1; }
        }
        @keyframes sidebarSlideOut {
            from { left: 0; opacity: 1; }
            to { left: -600px; opacity: 0; }
        }

        /* Dropdown fade-in/out */
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px);}
            to { opacity: 1; transform: translateY(0);}
        }
        @keyframes dropdownFadeOut {
            from { opacity: 1; transform: translateY(0);}
            to { opacity: 0; transform: translateY(-10px);}
        }

        /* Animate sidebar overlay on mobile/tablet */
        .sidebar__container[style*="left: 0px"] {
            animation: sidebarSlideIn 0.3s cubic-bezier(.4,0,.2,1);
        }
        .sidebar__container[style*="left: -600px"] {
            animation: sidebarSlideOut 0.3s cubic-bezier(.4,0,.2,1);
        }

        /* Animate dropdown */
        .dropdown-wrapper[style*="display: block"] {
            animation: dropdownFadeIn 0.2s cubic-bezier(.4,0,.2,1);
        }
        .dropdown-wrapper[style*="display: none"] {
            animation: dropdownFadeOut 0.2s cubic-bezier(.4,0,.2,1);
        }

        /* Animate menu button on hover */
        .menu-btn {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        }

        /* Animate sidebar nav item hover */
        .sidebarnav__item, .dropdown-item {
            transition: background-color 0.2s, transform 0.2s;
        }
        .sidebarnav__item:hover, .dropdown-item:hover {
            transform: translateX(6px) scale(1.03);
        }

        /* Animate document list items (if dynamically added) */
        .documents--list > * {
            animation: fadeInDoc 0.3s cubic-bezier(.4,0,.2,1);
        }
        @keyframes fadeInDoc {
            from { opacity: 0; transform: translateY(10px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;

            scrollbar-width: none; /* Chrome, Edge, Firefox, Opera, Brave */
        }
        .toolbar::-webkit-scrollbar {
            display: none; /* Safari */
        }
        .editor-content-editor {
            margin-top: 80px;
        }
        icon {
            cursor: pointer;
        }
        vl {
            margin: 0 10px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            height: 24px;
        }#renameMoreOptionsBtn {
            display: none;
        }
        @media (max-width: 560px) {
            #documentTitle {
                display: none;
            }
            #renameMoreOptionsBtn {
                display: flex !important;
            }            
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <omniwrite-sidebar class="sidebar__container">
            <div class="sidebar liquid-glass" id="sidebar">
                <div class="sidenav">
                <div class="sidebar__header">
                    <h3>OmniWrite</h3>
                    <div class="sidebar__header-right">
                       <icon id="createBtn">add</icon> 
                    </div>
                </div>
                <div class="sidebarnav__items">
                    <div class="sidebarnav__item">
                        <icon>filter</icon>
                        <div class="menu-text">Images</div>
                    </div>
                    <div class="sidebarnav__item">
                        <icon>task_alt</icon>
                        <div class="menu-text">Tasks</div>
                    </div>
                    <div class="sidebarnav__item">
                        <icon>browse</icon>
                        <div class="menu-text">Templates</div>
                    </div>
                </div> 
                <div class="search-bar liquid-glass" data-parent="true">
                        <icon>search</icon>
                        <input type="text" placeholder="Search documents" />
                    </div>
                <div class="sidebar__content">
                   
                    <div class="documents--list" id="documentsList">
                        <!-- Document items will be dynamically added here -->
                    </div>
                </div>
                <div class="sidebar__bottom">
                    <div class="settings-item sidebarnav__item">
                        <icon>settings</icon>
                        <div class="menu-text">Settings</div>
                    </div>
                    <div class="help-item sidebarnav__item">
                        <icon>help</icon>
                        <div class="menu-text">Help</div>
                    </div>
                </div>
            </div>
            </div>
        </omniwrite-sidebar>
        <div class="main-container">
            <div class="main-content">
                <div id="selectArea" class="page active">
                    <div class="navbar-container">
                        <div class="navbar">
                            <div class="menu-btn liquid-glass" id="toggleSidebar">
                                <icon>menu</icon>
                            </div>
                        </div>
                    </div>
                    <div class="content-area" id="contentArea">
                        <div class="select-area">
                            <h1>Welcome to Munetios OmniWrite</h1>
                            <p>Select or create a new document to get started.</p>
                        </div>
                    </div>
                </div>
                <div id="imagesApp" class="page">
                    <div class="navbar-container">
                        <div class="navbar">
                            <div class="navbar__left">
                                <div class="menu-btn liquid-glass" id="toggleSidebar">
                                    <icon>menu</icon>
                                </div>
                            </div>
                            <div class="navbar__right">
                                <div class="menu-btn liquid-glass" style="display: flex; align-items: center; gap: 10px;" id="uploadImageBtn">
                                    <icon>upload_file</icon>
                                    <div class="create-text">Upload Image</div>
                                </div>
                                <div class="menu-btn liquid-glass" id="moreImagesBtn">
                                    <icon>more_vert</icon>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="content-area" id="imagesContentArea">
                        <h1>Images</h1>
                        <div id="imagesList">No Images</div>
                    </div>
                </div>
                <div id="tasksApp" class="page">
                    <div class="navbar-container">
                        <div class="navbar">
                            <div class="navbar__left">
                                <div class="menu-btn liquid-glass" id="toggleSidebar">
                                    <icon>menu</icon>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="content-area" id="tasksContentArea">
                        <h1>Tasks</h1>
                        <iframe src="https://calendar.munetios.com/new/tasks.html" style="width: 100%; height: 100%; border: none; border-radius: 16px;"></iframe>
                    </div>
                </div>
                <div id="templatesApp" class="page">
                    <div class="navbar-container">
                        <div class="navbar">
                            <div class="menu-btn liquid-glass" id="toggleSidebar">
                                <icon>menu</icon>
                            </div>
                        </div>
                    </div>
                    <div class="content-area" id="templatesContentArea">
                        <h2>Templates</h2>
                        <div id="templatesList"></div>
                    </div>
            </div>
            <div id="editorContent" class="page">
                <div class="navbar-container">
                    <div class="navbar">
                        <div class="navbar__left">
                            <div class="menu-btn liquid-glass" id="toggleSidebar">
                                <icon>menu</icon>
                            </div>
                            <div class="liquid-glass" id="documentTitle" style="padding: 16px 14px;"></div>
                </div>
                <div class="navbar__right liquid-glass" style="padding: 11px 14px; display: flex; align-items: center; gap: 15px;">
                    <icon id="findInDocumentBtn">search</icon>
                    <icon id="versionHistoryBtn">history</icon>
                    <icon id="previewBtn" >visibility</icon>
                    <icon id="shareDocumentBtn">share</icon>
                    <icon id="moreEditorBtn">more_vert</icon>
                </div>
            </div>
            <div class="editor-content-editor">
                <div class="toolbar liquid-glass">
                    <div class="toolbar-item" id="boldBtn" title="Bold">
                        <icon>format_bold</icon>
                    </div>
                    <div class="toolbar-item" id="italicBtn" title="Italic">
                        <icon>format_italic</icon>
                    </div>
                    <div class="toolbar-item" id="underlineBtn" title="Underline">
                        <icon>format_underlined</icon>
                    </div>
                    <div class="toolbar-item" id="strikethroughBtn" title="Strikethrough">
                     <icon>strikethrough_s</icon>
                     </div>
                     <vl></vl>
                    <div class="toolbar-item" id="fontFamilyBtn" title="Font Family" style="min-width: 120px; vertical-align: center; display: flex; align-items: center; justify-content: center;">
                        <div class="menu-text" id="fontFamilyText">Google Sans Flex</div>
                    </div>
                    <div class="toolbar-item" id="fontSizeBtn" title="Font Size" style="min-width: 70px; vertical-align: center; display: flex; align-items: center; justify-content: center; position: relative;">
                        <div class="menu-text" id="fontSizeDisplay" style="cursor: pointer;">18px</div>
                    </div>

                   
       
                    <div class="toolbar-item" id="bulletListBtn" title="Bullet List">
                        <icon>format_list_bulleted</icon>
                        </div>
                    <div class="toolbar-item" id="numberedListBtn" title="Numbered List">
                        <icon>format_list_numbered</icon>
                        </div>
                    <div class="toolbar-item" id="checkboxListBtn" title="Checkbox List">
                        <icon>check_box</icon>
                        </div>
                        <vl></vl>
                        <div class="toolbar-item" id="alignLeftBtn" title="Align Left">
                            <icon>format_align_left</icon>
                        </div>
                        <div class="toolbar-item" id="alignCenterBtn" title="Align Center">
                            <icon>format_align_center</icon>
                        </div>
                        <div class="toolbar-item" id="alignRightBtn" title="Align Right">
                            <icon>format_align_right</icon>
                        </div>
        
                        <vl></vl>
                    <div class="toolbar-item" id="undoBtn" title="Undo">
                        <icon>undo</icon>
                        </div>
                    <div class="toolbar-item" id="redoBtn" title="Redo">
                        <icon>redo</icon>
                        </div>
                        <vl></vl>
                        <div class="toolbar-item" id="insertImageBtn" title="Insert Image">
                            <icon>image</icon>
                        </div>
                        <div class="toolbar-item" id="insertVideoBtn" title="Insert Video">
                            <icon>smart_display</icon>
                        </div>
                        <div class="toolbar-item" id="insertMusicBtn" title="Insert Music">
                            <icon>music_note</icon>
                        </div>
                        <div class="toolbar-item" id="insertQuoteBtn" title="Insert Quote">
                            <icon>format_quote</icon>
                        </div>
                        <div class="toolbar-item" id="insertCodeBlockBtn" title="Insert Code Block">
                            <icon>code</icon>
                        </div>
                        <div class="toolbar-item" id="insertTableBtn" title="Insert Table">
                            <icon>table_chart</icon>
                        </div>
                        <div class="toolbar-item" id="insertTableOfContentsBtn" title="Insert Table of Contents">
                            <icon>toc</icon>
                        </div>
                        <vl></vl>
                    <div class="toolbar-item" id="clearFormattingBtn" title="Clear Formatting">
                        <icon>format_clear</icon>
                        </div>
                    <div class="toolbar-item" id="heading1Btn" title="Heading 1">
                        <icon>looks_one</icon>
                    </div>
                    <div class="toolbar-item" id="heading2Btn" title="Heading 2">
                        <icon>looks_two</icon>
                    </div>
                    <div class="toolbar-item" id="heading3Btn" title="Heading 3">
                        <icon>looks_3</icon>
                    </div>

                    <div class="toolbar-item" id="superscriptBtn" title="Superscript">
                        <icon>superscript</icon>
                    </div>
                    <div class="toolbar-item" id="subscriptBtn" title="Subscript">
                        <icon>subscript</icon>
                    </div>
                    <div class="toolbar-item" id="highlightBtn" title="Highlight">
                        <icon>highlight</icon>
                    </div>
                    <div class="toolbar-item" id="textColorBtn" title="Text Color">
                        <icon>palette</icon>
                    </div>
                </div>
                <div id="editorArea" contenteditable="true" style="padding: 20px; min-height: calc(100vh - 200px); box-sizing: border-box; outline: none; border-radius: 16px; background-color: #1a0f3c; color: #FFFFFF; font-size: 18px; line-height: 1.9; margin-top: 12px;">
                    
                    </div>
            </div> 
        </div>
    </div> <!-- Close .main-container -->
                        <div class="dropdown-wrapper liquid-glass" id="fontSizePicker" style="min-width: 80px;">
                        <div class="dropdown-item" data-size="8"><div class="menu-text" style="font-size:8px;">8 px</div></div>
                        <div class="dropdown-item" data-size="10"><div class="menu-text" style="font-size:10px;">10 px</div></div>
                        <div class="dropdown-item" data-size="12"><div class="menu-text" style="font-size:12px;">12 px</div></div>
                        <div class="dropdown-item" data-size="14"><div class="menu-text" style="font-size:14px;">14 px</div></div>
                        <div class="dropdown-item" data-size="16"><div class="menu-text" style="font-size:16px;">16 px</div></div>
                        <div class="dropdown-item" data-size="18"><div class="menu-text" style="font-size:18px;">18 px</div></div>
                        <div class="dropdown-item" data-size="20"><div class="menu-text" style="font-size:20px;">20 px</div></div>
                        <div class="dropdown-item" data-size="22"><div class="menu-text" style="font-size:22px;">22 px</div></div>
                        <div class="dropdown-item" data-size="24"><div class="menu-text" style="font-size:24px;">24 px</div></div>
                        <div class="dropdown-item" data-size="28"><div class="menu-text" style="font-size:28px;">28 px</div></div>
                        <div class="dropdown-item" data-size="32"><div class="menu-text" style="font-size:32px;">32 px</div></div>
                        <div class="dropdown-item" data-size="36"><div class="menu-text" style="font-size:36px;">36 px</div></div>
                        <div class="dropdown-item" data-size="48"><div class="menu-text" style="font-size:48px;">48 px</div></div>
                        <div class="dropdown-item" data-size="60"><div class="menu-text" style="font-size:60px;">60 px</div></div>
                        <div class="dropdown-item" data-size="72"><div class="menu-text" style="font-size:72px;">72 px</div></div>
                    </div>
<div class="dropdown-wrapper liquid-glass" id="fontFamilyPicker">
    <div class="dropdown-item" data-font="'Google Sans Flex', sans-serif">
            <div class="menu-text" style="font-family: 'Google Sans Flex', sans-serif;">Google Sans Flex</div>
        </div>
        <div class="dropdown-item" data-font="Arial, sans-serif">
            <div class="menu-text" style="font-family: Arial, sans-serif;">Arial</div>
        </div>
        <div class="dropdown-item" data-font="'Helvetica Neue', sans-serif">
            <div class="menu-text" style="font-family: 'Helvetica Neue', sans-serif;">Helvetica Neue</div>
        </div>
        <div class="dropdown-item" data-font="'Times New Roman', serif">
            <div class="menu-text" style="font-family: 'Times New Roman', serif;">Times New Roman</div>
        </div>
        <div class="dropdown-item" data-font="'Courier New', monospace">
            <div class="menu-text" style="font-family: 'Courier New', monospace;">Courier New</div>
        </div>
        <div class="dropdown-item" data-font="'Georgia', serif">
            <div class="menu-text" style="font-family: 'Georgia', serif;">Georgia</div>
        </div>
        <div class="dropdown-item" data-font="'Segoe UI', sans-serif">
            <div class="menu-text" style="font-family: 'Segoe UI', sans-serif;">Segoe UI</div>
        </div>
        <div class="dropdown-item" data-font="'Verdana', sans-serif">
            <div class="menu-text" style="font-family: 'Verdana', sans-serif;">Verdana</div>
        </div>
        <!-- 50 Google Fonts as dropdown items -->
        <div class="dropdown-item" data-font="'Roboto', sans-serif">
            <div class="menu-text" style="font-family: 'Roboto', sans-serif;">Roboto</div>
        </div>
        <div class="dropdown-item" data-font="'Open Sans', sans-serif">
            <div class="menu-text" style="font-family: 'Open Sans', sans-serif;">Open Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Lato', sans-serif">
            <div class="menu-text" style="font-family: 'Lato', sans-serif;">Lato</div>
        </div>
        <div class="dropdown-item" data-font="'Montserrat', sans-serif">
            <div class="menu-text" style="font-family: 'Montserrat', sans-serif;">Montserrat</div>
        </div>
        <div class="dropdown-item" data-font="'Oswald', sans-serif">
            <div class="menu-text" style="font-family: 'Oswald', sans-serif;">Oswald</div>
        </div>
        <div class="dropdown-item" data-font="'Raleway', sans-serif">
            <div class="menu-text" style="font-family: 'Raleway', sans-serif;">Raleway</div>
        </div>
        <div class="dropdown-item" data-font="'Poppins', sans-serif">
            <div class="menu-text" style="font-family: 'Poppins', sans-serif;">Poppins</div>
        </div>
        <div class="dropdown-item" data-font="'Nunito', sans-serif">
            <div class="menu-text" style="font-family: 'Nunito', sans-serif;">Nunito</div>
        </div>
        <div class="dropdown-item" data-font="'Merriweather', serif">
            <div class="menu-text" style="font-family: 'Merriweather', serif;">Merriweather</div>
        </div>
        <div class="dropdown-item" data-font="'PT Sans', sans-serif">
            <div class="menu-text" style="font-family: 'PT Sans', sans-serif;">PT Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Source Sans Pro', sans-serif">
            <div class="menu-text" style="font-family: 'Source Sans Pro', sans-serif;">Source Sans Pro</div>
        </div>
        <div class="dropdown-item" data-font="'Ubuntu', sans-serif">
            <div class="menu-text" style="font-family: 'Ubuntu', sans-serif;">Ubuntu</div>
        </div>
        <div class="dropdown-item" data-font="'Playfair Display', serif">
            <div class="menu-text" style="font-family: 'Playfair Display', serif;">Playfair Display</div>
        </div>
        <div class="dropdown-item" data-font="'Quicksand', sans-serif">
            <div class="menu-text" style="font-family: 'Quicksand', sans-serif;">Quicksand</div>
        </div>
        <div class="dropdown-item" data-font="'Fira Sans', sans-serif">
            <div class="menu-text" style="font-family: 'Fira Sans', sans-serif;">Fira Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Rubik', sans-serif">
            <div class="menu-text" style="font-family: 'Rubik', sans-serif;">Rubik</div>
        </div>
        <div class="dropdown-item" data-font="'Josefin Sans', sans-serif">
            <div class="menu-text" style="font-family: 'Josefin Sans', sans-serif;">Josefin Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Bebas Neue', cursive">
            <div class="menu-text" style="font-family: 'Bebas Neue', cursive;">Bebas Neue</div>
        </div>
        <div class="dropdown-item" data-font="'Mukta', sans-serif">
            <div class="menu-text" style="font-family: 'Mukta', sans-serif;">Mukta</div>
        </div>
        <div class="dropdown-item" data-font="'Karla', sans-serif">
            <div class="menu-text" style="font-family: 'Karla', sans-serif;">Karla</div>
        </div>
        <div class="dropdown-item" data-font="'Arimo', sans-serif">
            <div class="menu-text" style="font-family: 'Arimo', sans-serif;">Arimo</div>
        </div>
        <div class="dropdown-item" data-font="'Titillium Web', sans-serif">
            <div class="menu-text" style="font-family: 'Titillium Web', sans-serif;">Titillium Web</div>
        </div>
        <div class="dropdown-item" data-font="'Cabin', sans-serif">
            <div class="menu-text" style="font-family: 'Cabin', sans-serif;">Cabin</div>
        </div>
        <div class="dropdown-item" data-font="'Dosis', sans-serif">
            <div class="menu-text" style="font-family: 'Dosis', sans-serif;">Dosis</div>
        </div>
        <div class="dropdown-item" data-font="'Google Sans', sans-serif">
            <div class="menu-text" style="font-family: 'Google Sans', sans-serif;">Google Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Google Sans Code', monospace">
            <div class="menu-text" style="font-family: 'Google Sans Code', monospace;">Google Sans Code</div>
        </div>
        <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:wght@400;700&display=swap" rel="stylesheet">
        <div class="dropdown-item" data-font="'Manrope', sans-serif">
            <div class="menu-text" style="font-family: 'Manrope', sans-serif;">Manrope</div>
        </div>
        <div class="dropdown-item" data-font="'Barlow', sans-serif">
            <div class="menu-text" style="font-family: 'Barlow', sans-serif;">Barlow</div>
        </div>
        <div class="dropdown-item" data-font="'Hind', sans-serif">
            <div class="menu-text" style="font-family: 'Hind', sans-serif;">Hind</div>
        </div>
        <div class="dropdown-item" data-font="'Archivo', sans-serif">
            <div class="menu-text" style="font-family: 'Archivo', sans-serif;">Archivo</div>
        </div>
        <div class="dropdown-item" data-font="'Muli', sans-serif">
            <div class="menu-text" style="font-family: 'Muli', sans-serif;">Muli</div>
        </div>
        <div class="dropdown-item" data-font="'Exo 2', sans-serif">
            <div class="menu-text" style="font-family: 'Exo 2', sans-serif;">Exo 2</div>
        </div>
        <div class="dropdown-item" data-font="'IBM Plex Sans', sans-serif">
            <div class="menu-text" style="font-family: 'IBM Plex Sans', sans-serif;">IBM Plex Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Varela Round', sans-serif">
            <div class="menu-text" style="font-family: 'Varela Round', sans-serif;">Varela Round</div>
        </div>
        <div class="dropdown-item" data-font="'Signika', sans-serif">
            <div class="menu-text" style="font-family: 'Signika', sans-serif;">Signika</div>
        </div>
        <div class="dropdown-item" data-font="'Asap', sans-serif">
            <div class="menu-text" style="font-family: 'Asap', sans-serif;">Asap</div>
        </div>
        <div class="dropdown-item" data-font="'Heebo', sans-serif">
            <div class="menu-text" style="font-family: 'Heebo', sans-serif;">Heebo</div>
        </div>
        <div class="dropdown-item" data-font="'Abel', sans-serif">
            <div class="menu-text" style="font-family: 'Abel', sans-serif;">Abel</div>
        </div>
        <div class="dropdown-item" data-font="'Tajawal', sans-serif">
            <div class="menu-text" style="font-family: 'Tajawal', sans-serif;">Tajawal</div>
        </div>
        <div class="dropdown-item" data-font="'Questrial', sans-serif">
            <div class="menu-text" style="font-family: 'Questrial', sans-serif;">Questrial</div>
        </div>
        <div class="dropdown-item" data-font="'Overpass', sans-serif">
            <div class="menu-text" style="font-family: 'Overpass', sans-serif;">Overpass</div>
        </div>
        <div class="dropdown-item" data-font="'Work Sans', sans-serif">
            <div class="menu-text" style="font-family: 'Work Sans', sans-serif;">Work Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Inter', sans-serif">
            <div class="menu-text" style="font-family: 'Inter', sans-serif;">Inter</div>
        </div>
        <div class="dropdown-item" data-font="'DM Sans', sans-serif">
            <div class="menu-text" style="font-family: 'DM Sans', sans-serif;">DM Sans</div>
        </div>
        <div class="dropdown-item" data-font="'Lexend', sans-serif">
            <div class="menu-text" style="font-family: 'Lexend', sans-serif;">Lexend</div>
        </div>
        <div class="dropdown-item" data-font="'Crimson Text', serif">
            <div class="menu-text" style="font-family: 'Crimson Text', serif;">Crimson Text</div>
        </div>
        <div class="dropdown-item" data-font="'Lora', serif">
            <div class="menu-text" style="font-family: 'Lora', serif;">Lora</div>
        </div>
        <div class="dropdown-item" data-font="'Cormorant Garamond', serif">
            <div class="menu-text" style="font-family: 'Cormorant Garamond', serif;">Cormorant Garamond</div>
        </div>
        <div class="dropdown-item" data-font="'EB Garamond', serif">
            <div class="menu-text" style="font-family: 'EB Garamond', serif;">EB Garamond</div>
        </div>
        <div class="dropdown-item" data-font="'Dancing Script', cursive">
            <div class="menu-text" style="font-family: 'Dancing Script', cursive;">Dancing Script</div>
        </div>
        <div class="dropdown-item" data-font="'Pacifico', cursive">
            <div class="menu-text" style="font-family: 'Pacifico', cursive;">Pacifico</div>
        </div>
        <div class="dropdown-item" data-font="'Indie Flower', cursive">
            <div class="menu-text" style="font-family: 'Indie Flower', cursive;">Indie Flower</div>
        </div>
        <div class="dropdown-item" data-font="'Shadows Into Light', cursive">
            <div class="menu-text" style="font-family: 'Shadows Into Light', cursive;">Shadows Into Light</div>
        </div>
        <!-- Google Fonts links -->
        <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Oswald:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Raleway:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Nunito:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Merriweather:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Rubik:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Bebas+Neue&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Mukta:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Karla:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Arimo:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Titillium+Web:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Cabin:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Dosis:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Manrope:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Barlow:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Hind:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Archivo:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Muli:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Exo+2:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Varela+Round&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Signika:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Asap:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Heebo:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Abel&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Tajawal:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Questrial&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Overpass:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=DM+Sans:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lexend:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Cormorant+Garamond:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=EB+Garamond:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script:400,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Indie+Flower&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Shadows+Into+Light&display=swap" rel="stylesheet">
</div>
<div class="dropdown-wrapper liquid-glass" id="editorMoreOptions">
    <div class="dropdown-item" id="renameMoreOptionsBtn">
        <icon>drive_file_rename_outline</icon>
        <div class="menu-text">Rename Document</div>
    </div>
    <div class="dropdown-item" id="versionHistoryMoreOptionsBtn">
        <icon>history</icon>
        <div class="menu-text">Version History</div>
    </div>
    <div class="dropdown-item" id="downloadMoreOptionsBtn">
        <icon>download</icon>
        <div class="menu-text">Download</div>
    </div>
    <div class="dropdown-item" id="duplicateMoreOptionsBtn">
        <icon>content_copy</icon>
        <div class="menu-text">Make a Copy</div>
    </div>
    <div class="dropdown-item" id="compareMoreOptionsBtn">
        <icon>compare_arrows</icon>
        <div class="menu-text">Compare Documents</div>
    </div>
    <div class="dropdown-item" id="shareMoreOptionsBtn">
        <icon>share</icon>
        <div class="menu-text">Share</div>
    </div>
    <div class="dropdown-item" id="deleteMoreOptionsBtn" style="color:#e74c3c;">
        <icon>delete</icon>
        <div class="menu-text">Delete</div>
    </div>
</div>
    <div class="dropdown-wrapper liquid-glass" id="createOptions">
        <div class="dropdown-item">
            <icon>description</icon>
            <div class="menu-text">New Document</div>
        </div>
        <div class="dropdown-item">
            <icon>image</icon>
            <div class="menu-text">New Image</div>
        </div>
        <div class="dropdown-item">
            <icon>upload_file</icon>
            <div class="menu-text">Import File</div>
        </div>
    </div>
    <div class="color-picker-wrapper liquid-glass" id="colorPicker">
        <div class="tabs">
            <div class="tab active" data-tab="swatch">Swatch</div>
        </div>
        <!-- Custom Color Picker not os defaults no input type color -->
        <div class="color-swatch-gradient"></div>
        <div id="colorHexDisplay" style="margin-top: 10px; font-family: monospace; font-size: 14px; text-align: center;">#FFFFFF</div>

    </div>
    <style>
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
        }
        .color-picker-wrapper {
            width: 330px;
            padding: 15px;
            border-radius: 12px;
            box-sizing: border-box;
            position: absolute;
            top: 60px;
            right: 20px;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            cursor: pointer;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
        }
        .tab.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .color-swatch-gradient {
            width: 300px;
            height: 300px;
            border-radius: 8px;
            cursor: crosshair;
            /* Full color spectrum: horizontal hue, vertical value/saturation */
            background: linear-gradient(to top, #000 0%, rgba(0,0,0,0) 50%, #fff 100%),
                linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%);
            position: relative;
        }
    </style>

    <script nonce="erjntgeryfheusjfhbdffeshF34YUH34yuhfuew8ufh34uidIRFEh3ui"> 
       const app = document.getElementById('app');
       
    // --- IndexedDB + Encryption Setup ---
    let documents = [];
    const DB_NAME = 'omniwrite-db';
    const DB_VERSION = 1;
    const DOC_STORE = 'documents';
    const KEY_STORE = 'cryptoKey';
    let db = null;
    let cryptoKey = null;

    // Open IndexedDB and initialize stores
    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = function(e) {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(DOC_STORE)) {
                    db.createObjectStore(DOC_STORE, { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains(KEY_STORE)) {
                    db.createObjectStore(KEY_STORE, { keyPath: 'name' });
                }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    // Generate or load encryption key from IndexedDB
    async function getOrCreateKey() {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(KEY_STORE, 'readwrite');
            const store = tx.objectStore(KEY_STORE);
            const getReq = store.get('main');
            getReq.onsuccess = async function() {
                if (getReq.result && getReq.result.key) {
                    // Import key
                    const raw = getReq.result.key;
                    const key = await window.crypto.subtle.importKey(
                        'raw', raw, 'AES-GCM', true, ['encrypt', 'decrypt']
                    );
                    resolve(key);
                } else {
                    // Generate new key
                    window.crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    ).then(async key => {
                        const raw = await window.crypto.subtle.exportKey('raw', key);
                        store.put({ name: 'main', key: raw });
                        resolve(key);
                    });
                }
            };
            getReq.onerror = () => reject(getReq.error);
        });
    }

    // Encrypt data (Uint8Array or string)
    async function encryptData(data) {
        const enc = new TextEncoder();
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const encoded = typeof data === 'string' ? enc.encode(data) : data;
        const ciphertext = await window.crypto.subtle.encrypt(
            { name: 'AES-GCM', iv }, cryptoKey, encoded
        );
        // Store iv + ciphertext
        return { iv: Array.from(iv), data: Array.from(new Uint8Array(ciphertext)) };
    }

    // Decrypt data
    async function decryptData(encObj) {
        const dec = new TextDecoder();
        const iv = new Uint8Array(encObj.iv);
        const ciphertext = new Uint8Array(encObj.data);
        const plaintext = await window.crypto.subtle.decrypt(
            { name: 'AES-GCM', iv }, cryptoKey, ciphertext
        );
        return dec.decode(plaintext);
    }

    // Save all documents to IndexedDB (encrypted)
    async function saveDocuments() {
        const tx = db.transaction(DOC_STORE, 'readwrite');
        const store = tx.objectStore(DOC_STORE);
        for (const doc of documents) {
            const encDoc = await encryptData(JSON.stringify(doc));
            store.put({ id: doc.id, enc: encDoc });
        }
    }

    // Load all documents from IndexedDB (decrypt)
    async function loadDocuments() {
        documents = [];
        return new Promise((resolve, reject) => {
            const tx = db.transaction(DOC_STORE, 'readonly');
            const store = tx.objectStore(DOC_STORE);
            const req = store.getAll();
            req.onsuccess = async function() {
                for (const item of req.result) {
                    try {
                        const docStr = await decryptData(item.enc);
                        const doc = JSON.parse(docStr);
                        documents.push(doc);
                        addDocumentToList(doc);
                    } catch (e) {
                        console.error('Failed to decrypt document', item.id, e);
                    }
                }
                resolve();
            };
            req.onerror = () => reject(req.error);
        });
    }

    // --- Initialization ---
    async function initializeApp() {
        // Patch DB for images/trash before opening
        if (typeof openDBPatched === 'undefined') {
            (function patchDBForImages() {
                const origOpenDB = openDB;
                openDB = function() {
                    return new Promise((resolve, reject) => {
                        const req = indexedDB.open(DB_NAME, DB_VERSION + 1);
                        req.onupgradeneeded = function(e) {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains(DOC_STORE)) {
                                db.createObjectStore(DOC_STORE, { keyPath: 'id' });
                            }
                            if (!db.objectStoreNames.contains(KEY_STORE)) {
                                db.createObjectStore(KEY_STORE, { keyPath: 'name' });
                            }
                            if (!db.objectStoreNames.contains('images')) {
                                db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
                            }
                            if (!db.objectStoreNames.contains('trashImages')) {
                                db.createObjectStore('trashImages', { keyPath: 'id', autoIncrement: true });
                            }
                        };
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    });
                };
                window.openDBPatched = true;
            })();
        }
        db = await openDB();
        cryptoKey = await getOrCreateKey();
        await loadDocuments();
        // Now handle hash after documents are loaded
        handleHashChangeWithDocument();
        window.addEventListener('hashchange', handleHashChangeWithDocument);
    }
    initializeApp();

    // Custom hash navigation for documents: #/document/<id>
    function handleHashChangeWithDocument() {
        const hash = window.location.hash;
        const docMatch = hash.match(/^#\/document\/(.+)$/);
        if (docMatch) {
            const docId = docMatch[1];
            openDocument(docId);
        } else if (hash === '#/tasks') {
            switchPage('tasksApp');
        } else if (hash === '#/images') {
            switchPage('imagesApp');
        } else if (hash === '#/templates') {
            switchPage('templatesApp');
        } else {
            switchPage('selectArea');
        }
    }
    // Remove any duplicate or conflicting hashchange listeners
    window.removeEventListener('hashchange', handleHashChange);
    window.removeEventListener('hashchange', handleHashChangeWithDocument);

    // When opening a document, update the hash
    function openDocument(docId) {
        const doc = documents.find(d => d.id === docId);
        if (!doc) return;
        window.location.hash = '#/document/' + docId;
        // Show editor page
        switchPage('editorContent');
        // Set title
        const titleDiv = document.getElementById('documentTitle');
        titleDiv.innerHTML = `<span contenteditable="true" id="editableTitle">${doc.title}</span>`;
        // Save title on blur or enter
        const editable = document.getElementById('editableTitle');
        editable.addEventListener('blur', async function() {
            doc.title = this.textContent.trim() || 'Untitled Document';
            this.textContent = doc.title;
            // Update sidebar
            const item = document.querySelector(`.document-item[data-doc-id="${doc.id}"] .menu-text`);
            if (item) item.textContent = doc.title;
            await saveDocuments();
        });
        editable.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
            }
        });
    }
    // Utility to create a document DOM element
    function createDocumentElement(doc) {
        const div = document.createElement('div');
        div.className = 'sidebarnav__item document-item';
        div.dataset.docId = doc.id;
        div.innerHTML = `<icon>description</icon><div class="menu-text">${doc.title}</div>`;
        div.addEventListener('click', () => {
            openDocument(doc.id);
            hideSidebarIfMobile();
        });
        return div;
    }

    // Add document to sidebar list
    function addDocumentToList(doc) {
        const list = document.getElementById('documentsList');
        const el = createDocumentElement(doc);
        list.appendChild(el);
    }

    // Open document in editor
    function openDocument(docId) {
        const doc = documents.find(d => d.id === docId);
        if (!doc) return;
        // Update hash only if not already set
        if (window.location.hash !== '#/document/' + docId) {
            window.location.hash = '#/document/' + docId;
            return; // Let hashchange handler do the rest
        }
        // Show editor page
        switchPage('editorContent');
        // Set editor content
        const editorArea = document.getElementById('editorArea');
        editorArea.innerHTML = doc.content || '';
        // After setting content, resolve all omniwrite image ids to blob URLs
        (async function resolveOmniwriteImages() {
            const imgs = editorArea.querySelectorAll('img[data-omniwrite-image-id]');
            for (const img of imgs) {
                const imageId = Number(img.getAttribute('data-omniwrite-image-id'));
                if (!isNaN(imageId)) {
                    try {
                        const tx = db.transaction('images', 'readonly');
                        const store = tx.objectStore('images');
                        const req = store.get(imageId);
                        req.onsuccess = function() {
                            if (req.result && req.result.file) {
                                const url = URL.createObjectURL(req.result.file);
                                img.src = url;
                                // Optionally, revokeObjectURL on image unload
                                img.addEventListener('load', () => {
                                    setTimeout(() => URL.revokeObjectURL(url), 60000);
                                });
                            } else {
                                img.alt = '[Image not found]';
                            }
                        };
                        req.onerror = function() {
                            img.alt = '[Image not found]';
                        };
                    } catch (e) {
                        img.alt = '[Image not found]';
                    }
                }
            }
        })();
        // Save content on input
        editorArea.oninput = async function() {
            doc.content = editorArea.innerHTML;
            await saveDocuments();
        };
        // --- Rich Text Formatting Toolbar Functionality ---

        // Utility: Apply execCommand and keep selection/caret in place
        function execCommandWithRestore(command, value = null) {
            document.execCommand(command, false, value);
        }

        // Bold
        document.getElementById('boldBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('bold');
        });

        // Italic
        document.getElementById('italicBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('italic');
        });

        // Underline
        document.getElementById('underlineBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('underline');
        });

        // Strikethrough
        document.getElementById('strikethroughBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('strikeThrough');
        });
        // Align Left
        document.getElementById('alignLeftBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('justifyLeft');
        });

        // Align Center
        document.getElementById('alignCenterBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('justifyCenter');
        });

        // Align Right
        document.getElementById('alignRightBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('justifyRight');
        });
        // Bullet List
        document.getElementById('bulletListBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('insertUnorderedList');
        });

        // Numbered List
        document.getElementById('numberedListBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('insertOrderedList');
        });
        // Checkbox List (toggle checkboxes)
        document.getElementById('checkboxListBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            // Toggle checkbox list for selected lines
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            // Expand to full lines
            let container = range.commonAncestorContainer;
            while (container && container.nodeType !== 1) container = container.parentNode;
            if (!container) container = editorArea;
            // Get selected blocks
            let blocks = [];
            if (sel.isCollapsed) {
            // Single line
            let node = sel.anchorNode;
            while (node && node !== editorArea && node.nodeName !== 'DIV' && node.nodeName !== 'LI') node = node.parentNode;
            if (node && node !== editorArea) blocks = [node];
            } else {
            // Multiple lines
            const fragment = range.cloneContents();
            blocks = Array.from(fragment.childNodes).filter(n => n.nodeType === 1);
            }
            if (blocks.length === 0) {
            // Fallback: wrap selection in <ul>
            execCommandWithRestore('insertUnorderedList');
            // Then convert <ul> to checklist
            setTimeout(() => {
                const ul = editorArea.querySelector('ul');
                if (ul) {
                ul.querySelectorAll('li').forEach(li => {
                    if (!li.querySelector('input[type="checkbox"]')) {
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.style.marginRight = '8px';
                    li.insertBefore(cb, li.firstChild);
                    }
                });
                // Listen for checkbox changes
                ul.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                    if (e.target.checked) {
                        e.target.parentNode.style.textDecoration = 'line-through';
                        e.target.parentNode.style.opacity = '0.6';
                    } else {
                        e.target.parentNode.style.textDecoration = '';
                        e.target.parentNode.style.opacity = '';
                    }
                    }
                });
                }
            }, 10);
            } else {
            blocks.forEach(block => {
                if (block.nodeName === 'LI') {
                // Toggle checkbox
                let cb = block.querySelector('input[type="checkbox"]');
                if (!cb) {
                    cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.style.marginRight = '8px';
                    block.insertBefore(cb, block.firstChild);
                } else {
                    cb.remove();
                }
                }
            });
            }
        });

        // Listen for checkbox changes in editorArea (for all checklists)
        editorArea.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
            if (e.target.checked) {
                e.target.parentNode.style.textDecoration = 'line-through';
                e.target.parentNode.style.opacity = '0.6';
            } else {
                e.target.parentNode.style.textDecoration = '';
                e.target.parentNode.style.opacity = '';
            }
            // Save after change
            doc.content = editorArea.innerHTML;
            saveDocuments();
            }
        });

        // Undo
        document.getElementById('undoBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('undo');
        });

        // Redo
        document.getElementById('redoBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('redo');
        });
        // Clear Formatting
        document.getElementById('clearFormattingBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('removeFormat');
        });

        // Heading 1
        document.getElementById('heading1Btn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('formatBlock', '<h1>');
        });

        // Heading 2
        document.getElementById('heading2Btn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('formatBlock', '<h2>');
        });

        // Heading 3
        document.getElementById('heading3Btn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('formatBlock', '<h3>');
        });
        // Superscript
        document.getElementById('superscriptBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('superscript');
        });

        // Subscript
        document.getElementById('subscriptBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            execCommandWithRestore('subscript');
        });

        // Highlight (background color)
        document.getElementById('highlightBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            // Use execCommand with 'hiliteColor' (modern browsers) or 'backColor' (IE)
            execCommandWithRestore('hiliteColor', '#ffe066');
            // Save after change
            doc.content = editorArea.innerHTML;
            saveDocuments();
        });
        // --- Insert Music Functionality ---
        const insertMusicBtn = document.getElementById('insertMusicBtn');
        let musicInsertModal = null;

        insertMusicBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            showMusicInsertModal();
        });
        // --- Insert Quote Functionality ---
        // Add context menu for quote color
        document.getElementById('editorArea').addEventListener('contextmenu', function(e) {
            // Only show for blockquote
            let node = e.target;
            while (node && node !== this) {
            if (node.nodeName === 'BLOCKQUOTE') {
                e.preventDefault();
                // Remove any existing context menu
                let oldMenu = document.getElementById('quote-context-menu');
                if (oldMenu) oldMenu.remove();
                // Create menu
                const menu = document.createElement('div');
                menu.id = 'quote-context-menu';
                menu.style.position = 'fixed';
                menu.style.top = e.clientY + 'px';
                menu.style.left = e.clientX + 'px';
                menu.style.background = 'rgba(30,30,40,0.1)';
                menu.style.backdropFilter = 'blur(2px)';
                menu.style.border = '1px solid rgba(255,255,255,0.2)';
                menu.style.color = '#fff';
                menu.style.padding = '10px 18px';
                menu.style.borderRadius = '10px';
                menu.style.boxShadow = '0 2px 16px rgba(0,0,0,0.18)';
                menu.style.zIndex = 999999;
                menu.style.cursor = 'pointer';
                menu.style.fontSize = '15px';
                menu.textContent = 'Change Quote Color';
                menu.onmousedown = function(ev) { ev.preventDefault(); };
                menu.onclick = function() {
                // Show color picker below menu
                const colorPicker = document.getElementById('colorPicker');
                colorPicker.style.display = 'flex';
                colorPicker.style.top = (e.clientY + 8) + 'px';
                colorPicker.style.left = (e.clientX - 150) + 'px';
                // When color picked, apply to blockquote border
                let handler = function(ev2) {
                    // Get color from display
                    const hex = document.getElementById('colorHexDisplay').textContent;
                    node.style.borderLeft = '4px solid ' + hex;
                    // Save doc
                    const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
                    const doc = documents.find(d => d.id === docId);
                    if (doc) {
                    doc.content = document.getElementById('editorArea').innerHTML;
                    saveDocuments();
                    }
                    colorPicker.style.display = 'none';
                    menu.remove();
                    colorPicker.querySelector('.color-swatch-gradient').removeEventListener('mousedown', handler);
                };
                colorPicker.querySelector('.color-swatch-gradient').addEventListener('mousedown', handler);
                };
                document.body.appendChild(menu);
                // Remove menu on click elsewhere
                document.addEventListener('mousedown', function removeMenu(ev2) {
                if (!menu.contains(ev2.target)) {
                    menu.remove();
                    document.removeEventListener('mousedown', removeMenu);
                }
                });
                break;
            }
            node = node.parentNode;
            }
        });
        document.getElementById('insertQuoteBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();
            const sel = window.getSelection();
            let quote = document.createElement('blockquote');
            quote.style.borderLeft = '4px solid #ffe066';
            quote.style.padding = '8px 16px';
            quote.style.margin = '12px 0';
            quote.style.background = 'rgba(255,255,255,0.04)';
            quote.style.borderRadius = '8px';
            quote.innerHTML = sel && !sel.isCollapsed ? sel.toString() : 'Quote text...';
            if (sel && sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(quote);
            } else {
            editorArea.appendChild(quote);
            }
            doc.content = editorArea.innerHTML;
            saveDocuments();
        });

        // --- Insert Code Block Functionality ---
        document.getElementById('insertCodeBlockBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();
            const sel = window.getSelection();
            let pre = document.createElement('pre');
            pre.style.background = '#191a2a';
            pre.style.color = '#ffe066';
            pre.style.padding = '12px 16px';
            pre.style.borderRadius = '8px';
            pre.style.fontFamily = 'monospace';
            pre.style.fontSize = '15px';
            pre.style.margin = '12px 0';
            pre.innerHTML = sel && !sel.isCollapsed ? sel.toString() : 'Code here...';
            if (sel && sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(pre);
            } else {
            editorArea.appendChild(pre);
            }
            doc.content = editorArea.innerHTML;
            saveDocuments();
        });
        // --- Insert Table of Contents Functionality ---
        document.getElementById('insertTableOfContentsBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();

            // Gather all headings in the editor
            const headings = Array.from(editorArea.querySelectorAll('h1, h2, h3, h4, h5, h6'));
            if (headings.length === 0) {
            showToast('No headings found to build Table of Contents.', { type: 'info' });
            return;
            }

            // Assign unique IDs to headings if missing
            headings.forEach((heading, idx) => {
            if (!heading.id) {
                heading.id = 'toc-heading-' + (idx + 1) + '-' + Math.random().toString(36).substr(2, 6);
            }
            });

            // Build TOC HTML
            let tocHtml = '<div class="toc-block" style="background:rgba(255,255,255,0.04);padding:16px 18px;border-radius:10px;margin:18px 0;"><strong style="font-size:18px;">Table of Contents</strong><ul style="list-style:none;padding-left:0;margin-top:12px;">';
            headings.forEach(heading => {
            const level = parseInt(heading.tagName[1]);
            const indent = (level - 1) * 18;
            tocHtml += `<li style="margin-bottom:6px;margin-left:${indent}px;">
                <a href="#${heading.id}" class="toc-link" style="color:#ffe066;text-decoration:none;font-size:${18 - (level-1)*2}px;cursor:pointer;">
                ${heading.textContent}
                </a>
            </li>`;
            });
            tocHtml += '</ul></div>';

            // Insert at caret
            const sel = window.getSelection();
            if (sel.rangeCount) {
            const range = sel.getRangeAt(0);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = tocHtml;
            const tocNode = tempDiv.firstChild;
            range.deleteContents();
            range.insertNode(tocNode);
            } else {
            editorArea.insertAdjacentHTML('beforeend', tocHtml);
            }

            // Save after insert
            doc.content = editorArea.innerHTML;
            saveDocuments();

            // Add click handler for TOC links (delegate for all future TOCs)
            editorArea.addEventListener('click', function(e) {
            if (e.target.classList && e.target.classList.contains('toc-link')) {
                e.preventDefault();
                const targetId = e.target.getAttribute('href').replace('#', '');
                const target = editorArea.querySelector('#' + CSS.escape(targetId));
                if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Optionally highlight the heading
                target.style.transition = 'background 0.5s';
                const oldBg = target.style.background;
                target.style.background = 'rgba(255,224,102,0.18)';
                setTimeout(() => { target.style.background = oldBg; }, 900);
                }
            }
            }, { once: true });
        });
        // --- Insert Table Functionality with Row/Column Picker ---
        document.getElementById('insertTableBtn').addEventListener('mousedown', function(e) {
            e.preventDefault();
            // Show a modal to pick rows/columns
            let modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:340px;">
                <span class="modal-content-close" id="closeTableModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                <h2>Insert Table</h2>
                <div style="margin:18px 0;">
                <label style="display:block;margin-bottom:8px;">Rows: <input id="tableRows" type="number" min="1" max="20" value="3" style="width:60px;margin-left:8px;"></label>
                <label style="display:block;margin-bottom:18px;">Columns: <input id="tableCols" type="number" min="1" max="20" value="3" style="width:60px;margin-left:8px;"></label>
                <button id="insertTableConfirmBtn">Insert Table</button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#closeTableModal').onclick = () => {
            modal.remove();
            };
            modal.querySelector('#insertTableConfirmBtn').onclick = function() {
            const rows = Math.max(1, Math.min(20, parseInt(modal.querySelector('#tableRows').value) || 3));
            const cols = Math.max(1, Math.min(20, parseInt(modal.querySelector('#tableCols').value) || 3));
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.margin = '12px 0';
            table.style.background = 'rgba(255,255,255,0.04)';
            table.style.borderRadius = '8px';
            for (let i = 0; i < rows; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < cols; j++) {
                const cell = document.createElement(i === 0 ? 'th' : 'td');
                cell.style.border = '1px solid #ffe066';
                cell.style.padding = '8px';
                cell.style.textAlign = 'left';
                cell.contentEditable = 'true';
                cell.innerHTML = i === 0 ? `Header ${j + 1}` : '';
                tr.appendChild(cell);
                }
                table.appendChild(tr);
            }
            const sel = window.getSelection();
            if (sel && sel.rangeCount) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(table);
            } else {
                editorArea.appendChild(table);
            }
            // Save after insert
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const doc = documents.find(d => d.id === docId);
            if (doc) {
                doc.content = editorArea.innerHTML;
                saveDocuments();
            }
            modal.remove();
            };
        });
        function showMusicInsertModal() {
            // Remove existing modal if any
            if (musicInsertModal) musicInsertModal.remove();

            musicInsertModal = document.createElement('div');
            musicInsertModal.className = 'modal';
            musicInsertModal.innerHTML = `
            <div class="modal-content" style="position:relative;">
                <span class="modal-content-close" id="closeMusicInsertModal">&times;</span>
                <h2>Insert Music</h2>
                <div style="margin-bottom:18px;">
                <button id="insertMusicFromFileBtn">Upload Music File</button>
                </div>
                <div id="musicInsertContent"></div>
            </div>
            `;
            document.body.appendChild(musicInsertModal);

            // Close modal
            musicInsertModal.querySelector('#closeMusicInsertModal').onclick = () => {
            musicInsertModal.remove();
            musicInsertModal = null;
            };

            // Insert from File
            musicInsertModal.querySelector('#insertMusicFromFileBtn').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*';
            input.onchange = async function() {
                const file = input.files[0];
                if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    insertMusicAtCaret(ev.target.result, file.name);
                    musicInsertModal.remove();
                    musicInsertModal = null;
                    showToast('Music inserted.', { type: 'success' });
                };
                reader.readAsDataURL(file);
                }
            };
            input.click();
            };
        }

        function insertMusicAtCaret(dataUrl, alt = '') {
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();
            const audio = document.createElement('audio');
            audio.src = dataUrl;
            audio.controls = true;
            audio.style.maxWidth = '100%';
            audio.style.borderRadius = '8px';
            audio.style.margin = '8px 0';
            audio.setAttribute('title', alt || '');
            // Insert at caret
            const sel = window.getSelection();
            if (sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(audio);
            } else {
            editorArea.appendChild(audio);
            }
            // Save after insert
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const doc = documents.find(d => d.id === docId);
            if (doc) {
            doc.content = editorArea.innerHTML;
            saveDocuments();
            }
            // Immediately upgrade audio players for custom controls
            upgradeAudioPlayers();
        }
        // --- Custom Audio Controls ---
        function upgradeAudioPlayers() {
            const editorArea = document.getElementById('editorArea');
            editorArea.querySelectorAll('audio').forEach(audio => {
            // Skip if already upgraded
            if (audio.nextSibling && audio.nextSibling.classList && audio.nextSibling.classList.contains('custom-audio-controls')) return;

            audio.style.display = 'none';
            // Create controls container
            const controls = document.createElement('div');
            controls.className = 'custom-audio-controls';
            controls.style.display = 'flex';
            controls.style.alignItems = 'center';
            controls.style.gap = '12px';
            controls.style.background = 'rgba(255,255,255,0.07)';
            controls.style.borderRadius = '8px';
            controls.style.padding = '8px 12px';
            controls.style.margin = '8px 0';
            controls.style.userSelect = 'none';

            // Play/Pause button
            const playBtn = document.createElement('button');
            playBtn.innerHTML = '<icon>play_arrow</icon>';
            playBtn.style.background = 'transparent';
            playBtn.style.border = 'none';
            playBtn.style.color = '#fff';
            playBtn.style.fontSize = '24px';
            playBtn.style.cursor = 'pointer';

            // Timestamp
            const timeDisplay = document.createElement('span');
            timeDisplay.textContent = '0:00 / 0:00';
            timeDisplay.style.fontFamily = 'monospace';
            timeDisplay.style.fontSize = '15px';
            timeDisplay.style.minWidth = '90px';

            // Slider
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.min = 0;
            slider.max = 1000;
            slider.value = 0;
            slider.style.flex = '1';
            slider.style.margin = '0 8px';
            slider.style.height = '3px';
            slider.style.background = '#ffe066';

            // Volume icon
            const volumeBtn = document.createElement('button');
            volumeBtn.innerHTML = '<icon>volume_up</icon>';
            volumeBtn.style.background = 'transparent';
            volumeBtn.style.border = 'none';
            volumeBtn.style.color = '#fff';
            volumeBtn.style.fontSize = '22px';
            volumeBtn.style.cursor = 'pointer';

            // Volume slider (hidden by default)
            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.min = 0;
            volumeSlider.max = 100;
            volumeSlider.value = 100;
            volumeSlider.style.width = '70px';
            volumeSlider.style.marginLeft = '6px';
            volumeSlider.style.display = 'none';

            // More icon (speed)
            const moreBtn = document.createElement('button');
            moreBtn.innerHTML = '<icon>more_vert</icon>';
            moreBtn.style.background = 'transparent';
            moreBtn.style.border = 'none';
            moreBtn.style.color = '#fff';
            moreBtn.style.fontSize = '22px';
            moreBtn.style.cursor = 'pointer';

            // Speed dropdown
            const speedDropdown = document.createElement('div');
            speedDropdown.className = 'dropdown-wrapper liquid-glass';
            speedDropdown.style.position = 'absolute';
            speedDropdown.style.minWidth = '90px';
            speedDropdown.style.display = 'none';
            speedDropdown.style.zIndex = '1000000';
            [
                0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 5, 10, 16
            ].forEach(spd => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerHTML = `<div class="menu-text">${spd}x</div>`;
                item.addEventListener('mousedown', function(e) {
                e.preventDefault();
                audio.playbackRate = spd;
                moreBtn.title = `Speed: ${spd}x`;
                speedDropdown.style.display = 'none';
                });
                speedDropdown.appendChild(item);
            });

            // Play/Pause logic
            playBtn.onclick = () => {
                if (audio.paused) {
                audio.play();
                } else {
                audio.pause();
                }
            };
            audio.addEventListener('play', () => {
                playBtn.innerHTML = '<icon>pause</icon>';
            });
            audio.addEventListener('pause', () => {
                playBtn.innerHTML = '<icon>play_arrow</icon>';
            });

            // Timestamp update
            function formatTime(sec) {
                sec = Math.floor(sec);
                const m = Math.floor(sec / 60);
                const s = sec % 60;
                return `${m}:${s.toString().padStart(2, '0')}`;
            }
            function updateTime() {
                timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration || 0)}`;
                slider.value = audio.duration ? Math.floor((audio.currentTime / audio.duration) * 1000) : 0;
            }
            audio.addEventListener('timeupdate', updateTime);
            audio.addEventListener('loadedmetadata', updateTime);
            slider.oninput = function() {
                if (audio.duration) {
                audio.currentTime = (slider.value / 1000) * audio.duration;
                }
            };

            // Volume logic
            volumeBtn.onclick = function() {
                volumeSlider.style.display = volumeSlider.style.display === 'none' ? 'inline-block' : 'none';
            };
            volumeSlider.oninput = function() {
                audio.volume = volumeSlider.value / 100;
                volumeBtn.innerHTML = audio.volume === 0 ? '<icon>volume_off</icon>' : '<icon>volume_up</icon>';
            };
            audio.addEventListener('volumechange', function() {
                volumeSlider.value = Math.round(audio.volume * 100);
                volumeBtn.innerHTML = audio.volume === 0 ? '<icon>volume_off</icon>' : '<icon>volume_up</icon>';
            });

            // More (speed) logic
            moreBtn.onclick = function(e) {
                e.preventDefault();
                // Position dropdown below button
                const rect = moreBtn.getBoundingClientRect();
                speedDropdown.style.top = (rect.bottom + window.scrollY + 2) + 'px';
                speedDropdown.style.left = (rect.left + window.scrollX - 30) + 'px';
                speedDropdown.style.display = speedDropdown.style.display === 'block' ? 'none' : 'block';
            };
            document.addEventListener('mousedown', function(e) {
                if (speedDropdown.style.display === 'block' && !speedDropdown.contains(e.target) && !moreBtn.contains(e.target)) {
                speedDropdown.style.display = 'none';
                }
            });

            // Assemble controls
            controls.appendChild(playBtn);
            controls.appendChild(timeDisplay);
            controls.appendChild(slider);
            controls.appendChild(volumeBtn);
            controls.appendChild(volumeSlider);
            controls.appendChild(moreBtn);
            document.body.appendChild(speedDropdown);

            // Insert controls after audio
            audio.parentNode.insertBefore(controls, audio.nextSibling);

            // Remove controls on audio removal
            const observer = new MutationObserver(function(muts) {
                muts.forEach(mut => {
                mut.removedNodes.forEach(node => {
                    if (node === audio) {
                    controls.remove();
                    speedDropdown.remove();
                    observer.disconnect();
                    }
                });
                });
            });
            observer.observe(audio.parentNode, { childList: true });

            // Initial state
            updateTime();
            volumeSlider.value = Math.round(audio.volume * 100);
            moreBtn.title = `Speed: ${audio.playbackRate}x`;
            });
        }

        // Upgrade audio players on document open and after insert
        upgradeAudioPlayers();
        editorArea.addEventListener('input', upgradeAudioPlayers);
        // Also upgrade after music insert
        editorArea.addEventListener('DOMNodeInserted', function(e) {
            if (e.target.nodeName === 'AUDIO') {
            setTimeout(upgradeAudioPlayers, 10);
            }
        });
        // --- Text Color Picker Functionality ---
        const textColorBtn = document.getElementById('textColorBtn');
        const colorPicker = document.getElementById('colorPicker');
        let colorPickerTarget = null;

        // Show/hide color picker when clicking the palette button
        textColorBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            // Position color picker below the button
            const rect = textColorBtn.getBoundingClientRect();
            colorPicker.style.top = (rect.bottom + window.scrollY + 4) + 'px';
            colorPicker.style.left = (rect.left + window.scrollX - 300) + 'px';
            colorPicker.style.display = colorPicker.style.display === 'flex' ? 'none' : 'flex';
            colorPickerTarget = 'foreColor';
        });

        // Hide color picker when clicking outside
        document.addEventListener('mousedown', function(e) {
            if (
            colorPicker.style.display === 'flex' &&
            !colorPicker.contains(e.target) &&
            !textColorBtn.contains(e.target)
            ) {
            colorPicker.style.display = 'none';
            }
        });

        // Color swatch click handler
        colorPicker.querySelector('.color-swatch-gradient').addEventListener('mousedown', function(e) {
            // Get click position relative to swatch
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            // Convert x/y to HSV and then to RGB/HEX
            // Horizontal: hue (0-360), Vertical: value/saturation
            const hue = (x / rect.width) * 360;
            const sat = 1 - (y / rect.height) * 0.8; // 0.2-1.0
            const val = 1 - (y / rect.height) * 0.8; // 0.2-1.0

            // HSV to RGB
            function hsvToRgb(h, s, v) {
            let f = (n, k = (n + h / 60) % 6) =>
                v - v * s * Math.max(Math.min(k, 4 - k, 1), 0);
            return [
                Math.round(f(5) * 255),
                Math.round(f(3) * 255),
                Math.round(f(1) * 255)
            ];
            }
            const rgb = hsvToRgb(hue, sat, val);
            const hex = '#' + rgb.map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();

            // Show hex in display
            document.getElementById('colorHexDisplay').textContent = hex;

            // Apply color to selection
            if (colorPickerTarget === 'foreColor') {
            document.execCommand('foreColor', false, hex);
            } else if (colorPickerTarget === 'hiliteColor') {
            document.execCommand('hiliteColor', false, hex);
            }
            // Save after change
            doc.content = editorArea.innerHTML;
            saveDocuments();

            // Hide picker after pick (optional: comment out if you want it to stay open)
            colorPicker.style.display = 'none';
        });
        // --- Insert Video Functionality ---
        const insertVideoBtn = document.getElementById('insertVideoBtn');
        let videoInsertModal = null;

        insertVideoBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            showVideoInsertModal();
        });

        function showVideoInsertModal() {
            // Remove existing modal if any
            if (videoInsertModal) videoInsertModal.remove();

            videoInsertModal = document.createElement('div');
            videoInsertModal.className = 'modal';
            videoInsertModal.innerHTML = `
            <div class="modal-content" style="position:relative;">
            <span class="modal-content-close" id="closeVideoInsertModal">&times;</span>
            <h2>Insert Video</h2>
            <div style="margin-bottom:18px;">
            <button id="insertVideoFromFileBtn">Upload Video File</button>
            </div>
            <div id="videoInsertContent"></div>
            </div>
            `;
            document.body.appendChild(videoInsertModal);

            // Close modal
            videoInsertModal.querySelector('#closeVideoInsertModal').onclick = () => {
            videoInsertModal.remove();
            videoInsertModal = null;
            };

            // Insert from File
            videoInsertModal.querySelector('#insertVideoFromFileBtn').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.onchange = async function() {
            const file = input.files[0];
            if (file) {
            // Read file as data URL
            const reader = new FileReader();
            reader.onload = function(ev) {
                insertVideoAtCaret(ev.target.result, file.name);
                videoInsertModal.remove();
                videoInsertModal = null;
                showToast('Video inserted.', { type: 'success' });
            };
            reader.readAsDataURL(file);
            }
            };
            input.click();
            };
        }

        function insertVideoAtCaret(dataUrl, alt = '') {
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();
            const video = document.createElement('video');
            video.src = dataUrl;
            video.controls = true;
            video.style.maxWidth = '100%';
            video.style.borderRadius = '8px';
            video.style.margin = '8px 0';
            video.setAttribute('title', alt || '');
            // Insert at caret
            const sel = window.getSelection();
            if (sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(video);
            } else {
            editorArea.appendChild(video);
            }
            // Save after insert
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const doc = documents.find(d => d.id === docId);
            if (doc) {
            doc.content = editorArea.innerHTML;
            saveDocuments();
            }
            // Upgrade to custom controls
            upgradeVideoPlayers();
        }

        // --- Custom Video Controls ---
        function upgradeVideoPlayers() {
            const editorArea = document.getElementById('editorArea');
            editorArea.querySelectorAll('video').forEach(video => {
            // Skip if already upgraded
            if (video.nextSibling && video.nextSibling.classList && video.nextSibling.classList.contains('custom-video-controls')) return;

            video.style.display = 'block';
            video.style.maxWidth = '100%';
            video.style.borderRadius = '8px';
            video.style.margin = '8px 0';
            // Controls container
            const controls = document.createElement('div');
            controls.className = 'custom-video-controls';
            controls.style.display = 'flex';
            controls.style.alignItems = 'center';
            controls.style.gap = '12px';
            controls.style.background = 'rgba(255,255,255,0.07)';
            controls.style.borderRadius = '8px';
            controls.style.padding = '8px 12px';
            controls.style.margin = '8px 0';
            controls.style.userSelect = 'none';
            controls.style.width = '100%';

            // Play/Pause button
            const playBtn = document.createElement('button');
            playBtn.innerHTML = '<icon>play_arrow</icon>';
            playBtn.style.background = 'transparent';
            playBtn.style.border = 'none';
            playBtn.style.color = '#fff';
            playBtn.style.fontSize = '24px';
            playBtn.style.cursor = 'pointer';

            // Timestamp
            const timeDisplay = document.createElement('span');
            timeDisplay.textContent = '0:00 / 0:00';
            timeDisplay.style.fontFamily = 'monospace';
            timeDisplay.style.fontSize = '15px';
            timeDisplay.style.minWidth = '90px';

            // Slider
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.min = 0;
            slider.max = 1000;
            slider.value = 0;
            slider.style.flex = '1';
            slider.style.margin = '0 8px';
            slider.style.height = '3px';
            slider.style.background = '#ffe066';

            // Volume icon
            const volumeBtn = document.createElement('button');
            volumeBtn.innerHTML = '<icon>volume_up</icon>';
            volumeBtn.style.background = 'transparent';
            volumeBtn.style.border = 'none';
            volumeBtn.style.color = '#fff';
            volumeBtn.style.fontSize = '22px';
            volumeBtn.style.cursor = 'pointer';

            // Volume slider (hidden by default)
            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.min = 0;
            volumeSlider.max = 100;
            volumeSlider.value = 100;
            volumeSlider.style.width = '70px';
            volumeSlider.style.marginLeft = '6px';
            volumeSlider.style.display = 'none';

            // More icon (speed)
            const moreBtn = document.createElement('button');
            moreBtn.innerHTML = '<icon>more_vert</icon>';
            moreBtn.style.background = 'transparent';
            moreBtn.style.border = 'none';
            moreBtn.style.color = '#fff';
            moreBtn.style.fontSize = '22px';
            moreBtn.style.cursor = 'pointer';

            // Speed dropdown
            const speedDropdown = document.createElement('div');
            speedDropdown.className = 'dropdown-wrapper liquid-glass';
            speedDropdown.style.position = 'absolute';
            speedDropdown.style.minWidth = '90px';
            speedDropdown.style.display = 'none';
            speedDropdown.style.zIndex = '1000000';
            [
                0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 5, 10, 16
            ].forEach(spd => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerHTML = `<div class="menu-text">${spd}x</div>`;
                item.addEventListener('mousedown', function(e) {
                e.preventDefault();
                video.playbackRate = spd;
                moreBtn.title = `Speed: ${spd}x`;
                speedDropdown.style.display = 'none';
                });
                speedDropdown.appendChild(item);
            });

            // Play/Pause logic
            playBtn.onclick = () => {
                if (video.paused) {
                video.play();
                } else {
                video.pause();
                }
            };
            video.addEventListener('play', () => {
                playBtn.innerHTML = '<icon>pause</icon>';
            });
            video.addEventListener('pause', () => {
                playBtn.innerHTML = '<icon>play_arrow</icon>';
            });

            // Timestamp update
            function formatTime(sec) {
                sec = Math.floor(sec);
                const m = Math.floor(sec / 60);
                const s = sec % 60;
                return `${m}:${s.toString().padStart(2, '0')}`;
            }
            function updateTime() {
                timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration || 0)}`;
                slider.value = video.duration ? Math.floor((video.currentTime / video.duration) * 1000) : 0;
            }
            video.addEventListener('timeupdate', updateTime);
            video.addEventListener('loadedmetadata', updateTime);
            slider.oninput = function() {
                if (video.duration) {
                video.currentTime = (slider.value / 1000) * video.duration;
                }
            };

            // Volume logic
            volumeBtn.onclick = function() {
                volumeSlider.style.display = volumeSlider.style.display === 'none' ? 'inline-block' : 'none';
            };
            volumeSlider.oninput = function() {
                video.volume = volumeSlider.value / 100;
                volumeBtn.innerHTML = video.volume === 0 ? '<icon>volume_off</icon>' : '<icon>volume_up</icon>';
            };
            video.addEventListener('volumechange', function() {
                volumeSlider.value = Math.round(video.volume * 100);
                volumeBtn.innerHTML = video.volume === 0 ? '<icon>volume_off</icon>' : '<icon>volume_up</icon>';
            });

            // More (speed) logic
            moreBtn.onclick = function(e) {
                e.preventDefault();
                // Position dropdown below button
                const rect = moreBtn.getBoundingClientRect();
                speedDropdown.style.top = (rect.bottom + window.scrollY + 2) + 'px';
                speedDropdown.style.left = (rect.left + window.scrollX - 30) + 'px';
                speedDropdown.style.display = speedDropdown.style.display === 'block' ? 'none' : 'block';
            };
            document.addEventListener('mousedown', function(e) {
                if (speedDropdown.style.display === 'block' && !speedDropdown.contains(e.target) && !moreBtn.contains(e.target)) {
                speedDropdown.style.display = 'none';
                }
            });

            // Fullscreen button
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.innerHTML = '<icon>fullscreen</icon>';
            fullscreenBtn.style.background = 'transparent';
            fullscreenBtn.style.border = 'none';
            fullscreenBtn.style.color = '#fff';
            fullscreenBtn.style.fontSize = '22px';
            fullscreenBtn.style.cursor = 'pointer';
            fullscreenBtn.onclick = function() {
                if (video.requestFullscreen) {
                video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
                }
            };

            // Assemble controls
            controls.appendChild(playBtn);
            controls.appendChild(timeDisplay);
            controls.appendChild(slider);
            controls.appendChild(volumeBtn);
            controls.appendChild(volumeSlider);
            controls.appendChild(moreBtn);
            controls.appendChild(fullscreenBtn);
            document.body.appendChild(speedDropdown);

            // Insert controls after video
            video.parentNode.insertBefore(controls, video.nextSibling);

            // Remove controls on video removal
            const observer = new MutationObserver(function(muts) {
                muts.forEach(mut => {
                mut.removedNodes.forEach(node => {
                    if (node === video) {
                    controls.remove();
                    speedDropdown.remove();
                    observer.disconnect();
                    }
                });
                });
            });
            observer.observe(video.parentNode, { childList: true });

            // Initial state
            updateTime();
            volumeSlider.value = Math.round(video.volume * 100);
            moreBtn.title = `Speed: ${video.playbackRate}x`;
            });
        }

        // Upgrade video players on document open and after insert
        upgradeVideoPlayers();
        editorArea.addEventListener('input', upgradeVideoPlayers);
        editorArea.addEventListener('DOMNodeInserted', function(e) {
            if (e.target.nodeName === 'VIDEO') {
            setTimeout(upgradeVideoPlayers, 10);
            }
        });
        // --- Insert Image Functionality ---
        const insertImageBtn = document.getElementById('insertImageBtn');
        let imageInsertModal = null;

        insertImageBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            showImageInsertModal();
        });

        function showImageInsertModal() {
            // Remove existing modal if any
            if (imageInsertModal) imageInsertModal.remove();

            imageInsertModal = document.createElement('div');
            imageInsertModal.className = 'modal';
            imageInsertModal.innerHTML = `
            <div class="modal-content" style="position:relative;">
                <span class="modal-content-close" id="closeImageInsertModal">&times;</span>
                <h2>Insert Image</h2>
                <div style="margin-bottom:18px; display:flex; gap:12px;">
                <button id="insertFromLibraryBtn" style="margin-right:12px;">Choose from Library</button>
                <button id="insertFromFileBtn" style="margin-right:12px;">Upload File</button>
                <button id="insertFromUrlBtn">Insert from URL</button>
                </div>
                <div id="imageInsertContent"></div>
            </div>
            `;
            document.body.appendChild(imageInsertModal);

            // Close modal
            imageInsertModal.querySelector('#closeImageInsertModal').onclick = () => {
            imageInsertModal.remove();
            imageInsertModal = null;
            };

            // Insert from Library
            imageInsertModal.querySelector('#insertFromLibraryBtn').onclick = async () => {
            const content = imageInsertModal.querySelector('#imageInsertContent');
            content.innerHTML = 'Loading images...';
            const imgs = await getAllImages();
            if (!imgs.length) {
                content.innerHTML = '<div style="margin:16px 0;">No images in library.</div>';
                return;
            }
            content.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:16px;max-height:300px;overflow-y:auto;"></div>';
            const grid = content.firstChild;
            imgs.forEach(img => {
                let url = '';
                if (img.file instanceof Blob) {
                    url = URL.createObjectURL(img.file);
                } else {
                    // fallback or skip if file is not valid
                    return;
                }
                const imgEl = document.createElement('img');
                imgEl.src = url;
                imgEl.alt = img.name;
                imgEl.title = img.name;
                imgEl.style.width = '80px';
                imgEl.style.height = '80px';
                imgEl.style.objectFit = 'cover';
                imgEl.style.borderRadius = '8px';
                imgEl.style.cursor = 'pointer';
                imgEl.style.border = '2px solid transparent';
                imgEl.addEventListener('click', () => {
                    // Instead of inserting blob URL, insert a custom data attribute with image id
                    insertImageAtCaret('data-omniwrite-image-id:' + img.id, img.name);
                    imageInsertModal.remove();
                    imageInsertModal = null;
                });
                imgEl.addEventListener('mouseover', () => {
                    imgEl.style.border = '2px solid #ffe066';
                });
                imgEl.addEventListener('mouseout', () => {
                    imgEl.style.border = '2px solid transparent';
                });
                grid.appendChild(imgEl);
            });
            };

            // Insert from File
            imageInsertModal.querySelector('#insertFromFileBtn').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function() {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(ev) {
                        const dataUrl = ev.target.result;
                        insertImageAtCaret(dataUrl, file.name);
                        // Optionally add to library
                        await addImageToDB(file);
                        imageInsertModal.remove();
                        imageInsertModal = null;
                        showToast('Image inserted and added to library.', { type: 'success' });
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
            };

            // Insert from URL
            imageInsertModal.querySelector('#insertFromUrlBtn').onclick = () => {
            const content = imageInsertModal.querySelector('#imageInsertContent');
            content.innerHTML = `
                <div style="margin-top:16px;">
                <input type="text" id="imageUrlInput" placeholder="Paste image URL here" style="width:90%;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:16px;">
                <button id="insertUrlImageBtn" style="margin-left:8px;">Insert</button>
                </div>
                <div id="imageUrlError" style="color:#e74c3c;margin-top:8px;font-size:14px;"></div>
            `;
            const urlInput = content.querySelector('#imageUrlInput');
            const insertBtn = content.querySelector('#insertUrlImageBtn');
            const errorDiv = content.querySelector('#imageUrlError');
            insertBtn.onclick = () => {
                const url = urlInput.value.trim();
                if (!url || !/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)(\?.*)?$/i.test(url)) {
                errorDiv.textContent = 'Please enter a valid image URL.';
                return;
                }
                insertImageAtCaret(url, url);
                imageInsertModal.remove();
                imageInsertModal = null;
            };
            };
        }

        function insertImageAtCaret(url, alt = '') {
            const editorArea = document.getElementById('editorArea');
            editorArea.focus();
            let img;
            // If url is a special omniwrite image id, insert with data attribute
            if (typeof url === 'string' && url.startsWith('data-omniwrite-image-id:')) {
                const imageId = url.replace('data-omniwrite-image-id:', '');
                img = document.createElement('img');
                img.setAttribute('data-omniwrite-image-id', imageId);
                img.alt = alt || '';
                img.style.maxWidth = '100%';
                img.style.borderRadius = '8px';
                img.style.margin = '8px 0';
                const sel = window.getSelection();
                if (sel.rangeCount) {
                    const range = sel.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                } else {
                    editorArea.appendChild(img);
                }
                // Immediately resolve and set blob URL for the inserted image
                (async function() {
                    try {
                        const tx = db.transaction('images', 'readonly');
                        const store = tx.objectStore('images');
                        const req = store.get(Number(imageId));
                        req.onsuccess = function() {
                            if (req.result && req.result.file) {
                                const blobUrl = URL.createObjectURL(req.result.file);
                                img.src = blobUrl;
                                // Make image resizable
                                img.style.resize = 'both';
                                img.style.overflow = 'auto';
                                img.style.maxWidth = '100%';
                                img.style.maxHeight = '600px';
                                img.style.minWidth = '40px';
                                img.style.minHeight = '40px';
                                img.style.display = 'block';
                                img.addEventListener('mousedown', function(e) {
                                    // Prevent drag selection when resizing
                                    if (e.offsetX > img.clientWidth - 16 && e.offsetY > img.clientHeight - 16) {
                                        e.preventDefault();
                                    }
                                });
                                img.addEventListener('load', () => {
                                    setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                                });
                            } else {
                                img.alt = '[Image not found]';
                            }
                        };
                        req.onerror = function() {
                            img.alt = '[Image not found]';
                        };
                    } catch (e) {
                        img.alt = '[Image not found]';
                    }
                })();
            } else {
                // Insert image at caret using execCommand or Range API
                if (document.queryCommandSupported('insertImage')) {
                    document.execCommand('insertImage', false, url);
                    // Set alt attribute (execCommand doesn't set alt)
                    // Find the last inserted image
                    const imgs = editorArea.querySelectorAll('img');
                    if (imgs.length) {
                        img = imgs[imgs.length - 1];
                        img.alt = alt || '';
                        img.style.maxWidth = '100%';
                        img.style.borderRadius = '8px';
                        img.style.margin = '8px 0';
                    }
                } else {
                    // Fallback: Range API
                    img = document.createElement('img');
                    img.src = url;
                    img.alt = alt || '';
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.style.margin = '8px 0';
                    const sel = window.getSelection();
                    if (sel.rangeCount) {
                        const range = sel.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(img);
                    } else {
                        editorArea.appendChild(img);
                    }
                }
            }
            // Save after insert
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const doc = documents.find(d => d.id === docId);
            if (doc) {
                doc.content = editorArea.innerHTML;
                saveDocuments();
            }
        }
      
        // Font Size Picker
        const fontSizeBtn = document.getElementById('fontSizeBtn');
        const fontSizePicker = document.getElementById('fontSizePicker');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        // Show/hide picker
        fontSizeBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            if (fontSizePicker.style.display === 'block') {
            fontSizePicker.style.display = 'none';
            } else {
            // Position dropdown below the button
            const rect = fontSizeBtn.getBoundingClientRect();
            fontSizePicker.style.top = (rect.bottom + window.scrollY + 4) + 'px';
            fontSizePicker.style.left = (rect.left + window.scrollX) + 'px';
            fontSizePicker.style.display = 'block';
            }
        });
        // Hide picker when clicking outside
        document.addEventListener('mousedown', function(e) {
            if (
            fontSizePicker.style.display === 'block' &&
            !fontSizePicker.contains(e.target) &&
            !fontSizeBtn.contains(e.target)
            ) {
            fontSizePicker.style.display = 'none';
            }
        });
        // Apply font size
        fontSizePicker.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('mousedown', function(e) {
            e.preventDefault();
            const size = this.getAttribute('data-size');
            // Use execCommand with fontSize (1-7), then replace <font size> with inline style
            // We'll use px directly via a span
            document.execCommand('fontSize', false, 7); // 7 is largest, will be replaced
            // Replace <font size="7"> with <span style="font-size: XXpx">
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let range = selection.getRangeAt(0);
                // Find all <font size="7"> in editorArea and replace
                editorArea.querySelectorAll('font[size="7"]').forEach(fontEl => {
                const span = document.createElement('span');
                span.style.fontSize = size + 'px';
                span.innerHTML = fontEl.innerHTML;
                fontEl.parentNode.replaceChild(span, fontEl);
                });
            }
            fontSizeDisplay.textContent = size + 'px';
            fontSizePicker.style.display = 'none';
            // Save after change
            doc.content = editorArea.innerHTML;
            saveDocuments();
            });
        });
        // Font Family Picker
        const fontFamilyBtn = document.getElementById('fontFamilyBtn');
        const fontFamilyPicker = document.getElementById('fontFamilyPicker');
        const fontFamilyText = document.getElementById('fontFamilyText');
        // Show/hide picker
        fontFamilyBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            if (fontFamilyPicker.style.display === 'block') {
            fontFamilyPicker.style.display = 'none';
            } else {
            // Position dropdown below the button
            const rect = fontFamilyBtn.getBoundingClientRect();
            fontFamilyPicker.style.top = (rect.bottom + window.scrollY + 4) + 'px';
            fontFamilyPicker.style.left = (rect.left + window.scrollX) + 'px';
            fontFamilyPicker.style.display = 'block';
            }
        });
        // Hide picker when clicking outside
        document.addEventListener('mousedown', function(e) {
            if (
            fontFamilyPicker.style.display === 'block' &&
            !fontFamilyPicker.contains(e.target) &&
            !fontFamilyBtn.contains(e.target)
            ) {
            fontFamilyPicker.style.display = 'none';
            }
        });
        // Apply font family and update text
        fontFamilyPicker.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('mousedown', function(e) {
            e.preventDefault();
            const font = this.getAttribute('data-font');
            // Use execCommand to set fontName (for selection)
            document.execCommand('fontName', false, font.replace(/['"]/g, '').split(',')[0]);
            // Update toolbar display text and style
            fontFamilyText.textContent = this.innerText;
            fontFamilyText.style.fontFamily = font;
            fontFamilyPicker.style.display = 'none';
            // Save after change
            doc.content = editorArea.innerHTML;
            saveDocuments();
            });
        });

        // Update font family toolbar display based on caret position, only if selection is inside editorArea
        document.addEventListener('selectionchange', function() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            let node = selection.anchorNode;
            if (!node) return;
            // Only update if selection is inside the editorArea
            let insideEditor = false;
            let checkNode = node.nodeType === 3 ? node.parentNode : node;
            while (checkNode) {
                if (checkNode === editorArea) {
                    insideEditor = true;
                    break;
                }
                checkNode = checkNode.parentNode;
            }
            if (!insideEditor) return;
            // Traverse up to find a font-family style
            let font = '';
            let displayText = '';
            while (node && node !== editorArea && node !== document.body) {
                if (node.nodeType === 1) { // Element node
                    const computed = window.getComputedStyle(node);
                    if (computed.fontFamily) {
                        font = computed.fontFamily;
                        break;
                    }
                }
                node = node.parentNode;
            }
            if (!font) font = "'Google Sans Flex', sans-serif";
            // Find the dropdown item that matches this font
            let found = false;
            fontFamilyPicker.querySelectorAll('.dropdown-item').forEach(item => {
                const itemFont = item.getAttribute('data-font');
                if (itemFont && font.replace(/['"]/g, '').toLowerCase().startsWith(itemFont.replace(/['"]/g, '').toLowerCase().split(',')[0])) {
                    displayText = item.innerText;
                    fontFamilyText.textContent = displayText;
                    fontFamilyText.style.fontFamily = itemFont;
                    found = true;
                }
            });
            if (!found) {
                fontFamilyText.textContent = font.split(',')[0].replace(/['"]/g, '');
                fontFamilyText.style.fontFamily = font;
            }
        });
        // --- Preview Functionality ---
        const previewBtn = document.getElementById('previewBtn');
        let previewModal = null;

        previewBtn.addEventListener('click', function () {
            // Remove any existing modal from DOM
            document.querySelectorAll('.modal').forEach(m => m.remove());
            previewModal = null;

            // Create modal
            previewModal = document.createElement('div');
            previewModal.className = 'modal';
            previewModal.style.background = 'rgba(17,7,54,0.98)';
            previewModal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:900px;max-height:90vh;overflow:auto;background:#1a0f3c;color:#fff;">
                <span class="modal-content-close" id="closePreviewModal" style="position:absolute;top:18px;right:24px;cursor:pointer;font-size:28px;z-index:2;">&times;</span>
                <div id="previewContent" style="padding:32px 28px 24px 28px;min-height:60vh;"></div>
            </div>
            `;
            document.body.appendChild(previewModal);

            // Set preview content (read-only)
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const doc = documents.find(d => d.id === docId);
            if (doc) {
            previewModal.querySelector('#previewContent').innerHTML = doc.content;
            }

            // Request fullscreen for modal
            const modalContent = previewModal.querySelector('.modal-content');
            if (modalContent.requestFullscreen) {
            modalContent.requestFullscreen();
            } else if (modalContent.webkitRequestFullscreen) {
            modalContent.webkitRequestFullscreen();
            } else if (modalContent.mozRequestFullScreen) {
            modalContent.mozRequestFullScreen();
            } else if (modalContent.msRequestFullscreen) {
            modalContent.msRequestFullscreen();
            }

            // Close modal on close icon click
            previewModal.querySelector('#closePreviewModal').onclick = function () {
            // Exit fullscreen if in fullscreen
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                if (document.exitFullscreen) {
                document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
                }
            }
            previewModal.remove();
            previewModal = null;
            };

            // Also close modal if user presses Escape
            document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape' && previewModal) {
                previewModal.querySelector('#closePreviewModal').click();
                document.removeEventListener('keydown', escHandler);
            }
            });

            // Remove modal if fullscreen is exited by user
            function onFullscreenChange() {
            if (
                !(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement)
                && previewModal
            ) {
                previewModal.remove();
                previewModal = null;
                document.removeEventListener('fullscreenchange', onFullscreenChange);
                document.removeEventListener('webkitfullscreenchange', onFullscreenChange);
                document.removeEventListener('mozfullscreenchange', onFullscreenChange);
                document.removeEventListener('MSFullscreenChange', onFullscreenChange);
            }
            }
            document.addEventListener('fullscreenchange', onFullscreenChange);
            document.addEventListener('webkitfullscreenchange', onFullscreenChange);
            document.addEventListener('mozfullscreenchange', onFullscreenChange);
            document.addEventListener('MSFullscreenChange', onFullscreenChange);
        });
        // --- Version History Functionality ---
        const versionHistoryBtn = document.getElementById('versionHistoryBtn');
        let versionHistoryModal = null;

        // Save document version on every change
        async function saveDocumentVersion(doc) {
            if (!doc.versions) doc.versions = [];
            // Only save if content changed
            if (
            !doc.versions.length ||
            doc.versions[doc.versions.length - 1].content !== doc.content
            ) {
            doc.versions.push({
                content: doc.content,
                title: doc.title,
                time: Date.now()
            });
            await saveDocuments();
            }
        }
        // Patch editorArea.oninput to also save version
        const origEditorAreaOnInput = document.getElementById('editorArea').oninput;
        document.getElementById('editorArea').oninput = async function () {
            doc.content = this.innerHTML;
            await saveDocuments();
            await saveDocumentVersion(doc);
            if (typeof origEditorAreaOnInput === 'function') origEditorAreaOnInput.call(this);
        };

        versionHistoryBtn.addEventListener('click', function () {
            // Remove any existing modal from DOM
            document.querySelectorAll('.modal').forEach(m => m.remove());
            versionHistoryModal = null;
            versionHistoryModal = document.createElement('div');
            versionHistoryModal.className = 'modal';
            versionHistoryModal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:800px;">
                <span class="modal-content-close" id="closeVersionHistoryModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                <h2>Version History</h2>
                <div id="versionList" style="max-height:400px;overflow-y:auto;margin-top:18px;"></div>
                <div id="versionPreview" style="margin-top:24px;display:none;">
                <h3>Preview</h3>
                <div id="versionPreviewContent" style="background:#191a2a;color:#ffe066;padding:18px;border-radius:10px;max-height:300px;overflow:auto;"></div>
                <button id="restoreVersionBtn" style="margin-top:12px;">Restore This Version</button>
                </div>
            </div>
            `;
            document.body.appendChild(versionHistoryModal);

            // Close modal
            versionHistoryModal.querySelector('#closeVersionHistoryModal').onclick = () => {
            versionHistoryModal.remove();
            versionHistoryModal = null;
            };

            // Render version list
            const versionList = versionHistoryModal.querySelector('#versionList');
            versionList.innerHTML = '';
            if (!doc.versions || !doc.versions.length) {
            versionList.innerHTML = '<div style="margin:16px 0;">No versions saved yet.</div>';
            return;
            }
            doc.versions.forEach((ver, idx) => {
            const div = document.createElement('div');
            div.className = 'sidebarnav__item';
            div.style.cursor = 'pointer';
            div.style.marginBottom = '8px';
            div.innerHTML = `<icon>history</icon>
                <div class="menu-text">
                ${ver.title || 'Untitled'}<br>
                <span style="font-size:12px;opacity:0.7;">${new Date(ver.time).toLocaleString()}</span>
                </div>
                <button class="preview-btn" style="margin-left:auto;background:transparent;border:none;color:#fff;cursor:pointer;"><icon>visibility</icon></button>
                <button class="restore-btn" style="background:transparent;border:none;color:#fff;cursor:pointer;"><icon>restore</icon></button>
            `;
            // Preview button
            div.querySelector('.preview-btn').onclick = function (e) {
                e.stopPropagation();
                const preview = versionHistoryModal.querySelector('#versionPreview');
                preview.style.display = 'block';
                preview.querySelector('#versionPreviewContent').innerHTML = ver.content;
                preview.querySelector('#restoreVersionBtn').onclick = function () {
                doc.content = ver.content;
                document.getElementById('editorArea').innerHTML = ver.content;
                saveDocuments();
                showToast('Version restored.', { type: 'success' });
                versionHistoryModal.remove();
                versionHistoryModal = null;
                };
            };
            // Restore button
            div.querySelector('.restore-btn').onclick = function (e) {
                e.stopPropagation();
                doc.content = ver.content;
                document.getElementById('editorArea').innerHTML = ver.content;
                saveDocuments();
                showToast('Version restored.', { type: 'success' });
                versionHistoryModal.remove();
                versionHistoryModal = null;
            };
            versionList.appendChild(div);
            });
        });
        // --- Find in Document Functionality ---
        const findInDocumentBtn = document.getElementById('findInDocumentBtn');
        let findBar = null;

        findInDocumentBtn.addEventListener('click', function () {
            // If already open, focus input
            if (findBar && document.body.contains(findBar)) {
            findBar.querySelector('input').focus();
            return;
            }
            // Create find bar
            findBar = document.createElement('div');
            findBar.className = 'liquid-glass';
            findBar.style.position = 'fixed';
            findBar.style.top = '18px';
            findBar.style.right = '40px';
            findBar.style.zIndex = '10010';
            findBar.style.display = 'flex';
            findBar.style.alignItems = 'center';
            findBar.style.gap = '10px';
            findBar.style.padding = '10px 18px';
            findBar.style.borderRadius = '12px';
            findBar.innerHTML = `
            <icon style="font-size:22px;">search</icon>
            <input type="text" placeholder="Find in document..." style="font-size:16px;padding:7px 10px;border-radius:7px;border:none;outline:none;background:rgba(255,255,255,0.07);color:#fff;width:180px;">
            <span id="findCount" style="font-size:14px;opacity:0.7;"></span>
            <button id="findPrevBtn" style="background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer;"><icon>expand_less</icon></button>
            <button id="findNextBtn" style="background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer;"><icon>expand_more</icon></button>
            <button id="findCloseBtn" style="background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer;"><icon>close</icon></button>
            `;
            document.body.appendChild(findBar);

            const input = findBar.querySelector('input');
            const findCount = findBar.querySelector('#findCount');
            const findPrevBtn = findBar.querySelector('#findPrevBtn');
            const findNextBtn = findBar.querySelector('#findNextBtn');
            const findCloseBtn = findBar.querySelector('#findCloseBtn');
            const editorArea = document.getElementById('editorArea');

            let matches = [];
            let currentIdx = -1;

            // Remove highlights
            function clearHighlights() {
            // Remove all <mark class="find-highlight">
            const marks = editorArea.querySelectorAll('mark.find-highlight');
            marks.forEach(m => {
                const parent = m.parentNode;
                parent.replaceChild(document.createTextNode(m.textContent), m);
                parent.normalize();
            });
            }

            // Highlight all matches
            function highlightAll(term) {
            clearHighlights();
            matches = [];
            if (!term) {
                findCount.textContent = '';
                return;
            }
            // Collect all text nodes first to avoid breaking the TreeWalker
            function getTextNodes(node) {
                let nodes = [];
                if (node.nodeType === Node.TEXT_NODE) {
                    nodes.push(node);
                } else if (node.nodeType === Node.ELEMENT_NODE && node.childNodes && !['SCRIPT', 'STYLE', 'MARK'].includes(node.nodeName)) {
                    for (let child of node.childNodes) {
                        nodes = nodes.concat(getTextNodes(child));
                    }
                }
                return nodes;
            }
            const textNodes = getTextNodes(editorArea);
            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            textNodes.forEach(node => {
                let text = node.textContent;
                if (!text.trim()) return;
                let match;
                let lastIndex = 0;
                let parent = node.parentNode;
                let frag = document.createDocumentFragment();
                let found = false;
                while ((match = regex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                    }
                    const mark = document.createElement('mark');
                    mark.className = 'find-highlight';
                    mark.style.background = '#ffe066';
                    mark.style.color = '#110736';
                    mark.style.padding = '0 2px';
                    mark.textContent = match[0];
                    frag.appendChild(mark);
                    matches.push(mark);
                    lastIndex = match.index + match[0].length;
                    found = true;
                }
                if (found) {
                    if (lastIndex < text.length) {
                        frag.appendChild(document.createTextNode(text.slice(lastIndex)));
                    }
                    parent.replaceChild(frag, node);
                }
            });
            if (matches.length) {
                currentIdx = 0;
                updateActive();
            } else {
                currentIdx = -1;
            }
            findCount.textContent = matches.length ? `${currentIdx + 1} of ${matches.length}` : '0 found';
            }

            // Update active highlight
            function updateActive() {
            matches.forEach((m, i) => {
                m.style.background = i === currentIdx ? '#ffe066' : '#ffe06688';
                m.style.boxShadow = i === currentIdx ? '0 0 0 2px #ffe066' : '';
            });
            if (matches[currentIdx]) {
                matches[currentIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            findCount.textContent = matches.length ? `${currentIdx + 1} of ${matches.length}` : '0 found';
            }

            input.addEventListener('input', function () {
            highlightAll(this.value);
            });

            findNextBtn.addEventListener('click', function () {
            if (!matches.length) return;
            currentIdx = (currentIdx + 1) % matches.length;
            updateActive();
            });

            findPrevBtn.addEventListener('click', function () {
            if (!matches.length) return;
            currentIdx = (currentIdx - 1 + matches.length) % matches.length;
            updateActive();
            });

            findCloseBtn.addEventListener('click', function () {
            clearHighlights();
            findBar.remove();
            });

            // Keyboard navigation
            input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                findNextBtn.click();
                e.preventDefault();
            } else if (e.key === 'Escape') {
                findCloseBtn.click();
            }
            });

            // Focus input
            input.focus();
        });

        // Remove find bar if switching document or page
        window.addEventListener('hashchange', function () {
            if (findBar && document.body.contains(findBar)) {
            findBar.remove();
            }
        });

        // --- Share Document Functionality (Download as PDF) ---
        const shareDocumentBtn = document.getElementById('shareDocumentBtn');
        let shareModal = null;

        shareDocumentBtn.addEventListener('click', function () {
            // Remove any existing modal from DOM
            document.querySelectorAll('.modal').forEach(m => m.remove());
            shareModal = null;

            // Create modal
            shareModal = document.createElement('div');
            shareModal.className = 'modal';
            shareModal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:500px;">
            <span class="modal-content-close" id="closeShareModal" style="position:absolute;top:18px;right:24px;cursor:pointer;font-size:28px;z-index:2;">&times;</span>
            <h2>Share</h2>
            <p>Share this document with others by downloading it as a PDF file.</p>
            <div style="margin: 24px 0 18px 0;">
                <button id="downloadPdfBtn" style="font-size:17px;display:flex;align-items:center;gap:8px;">
                <icon>download</icon> Download as PDF
                </button>
            </div>
            <div style="font-size:14px;opacity:0.7;">Download a PDF version of this document.</div>
            </div>
            `;
            document.body.appendChild(shareModal);

            // Close modal on close icon click
            shareModal.querySelector('#closeShareModal').onclick = function () {
            shareModal.remove();
            shareModal = null;
            };

            // Download as PDF button
            shareModal.querySelector('#downloadPdfBtn').onclick = function () {
            // Get document content
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;

            // Create a new window for printing
            const printWindow = window.open('', '', 'width=900,height=900');
            printWindow.document.write(`
                <html>
                <head>
                <title>${doc.title}</title>
                <style>
                    body { font-family: 'Google Sans Flex', Arial, sans-serif; color: #222; background: #fff; margin: 40px; }
                    h1,h2,h3,h4,h5,h6 { font-variation-settings: 'ROND' 90; }
                    img, video, audio { max-width: 100%; border-radius: 8px; margin: 8px 0; }
                    table { border-collapse: collapse; width: 100%; margin: 12px 0; }
                    th, td { border: 1px solid #888; padding: 8px; }
                    blockquote { border-left: 4px solid #ffe066; padding: 8px 16px; background: #f9f9f9; border-radius: 8px; margin: 12px 0; }
                    pre { background: #191a2a; color: #ffe066; padding: 12px 16px; border-radius: 8px; font-family: monospace; font-size: 15px; margin: 12px 0; }
                    .toc-block { background: #f7f7f7; padding: 16px 18px; border-radius: 10px; margin: 18px 0; }
                    mark.find-highlight { background: #ffe066; color: #110736; padding: 0 2px; }
                </style>
                </head>
                <body>
                <h1>${doc.title}</h1>
                <div>${doc.content}</div>
                </body>
                </html>
            `);
            printWindow.document.close();

            // Wait for content to load, then print to PDF
            printWindow.onload = function () {
                printWindow.focus();
                printWindow.print();
                // Optionally, close after print
                setTimeout(() => printWindow.close(), 1000);
            };

            showToast('Print dialog opened. Choose "Save as PDF" to download.', { type: 'info' });
            };
        });
        // Set title
        const titleDiv = document.getElementById('documentTitle');
        titleDiv.innerHTML = `<span contenteditable="true" id="editableTitle">${doc.title}</span>`;
        // Save title on blur or enter
        const editable = document.getElementById('editableTitle');
        editable.addEventListener('blur', async function() {
            doc.title = this.textContent.trim() || 'Untitled Document';
            this.textContent = doc.title;
            // Update sidebar
            const item = document.querySelector(`.document-item[data-doc-id="${doc.id}"] .menu-text`);
            if (item) item.textContent = doc.title;
            await saveDocuments();
        });
        editable.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
            }
        });
    }
    // --- More Editor Options Dropdown Functionality ---
    const moreEditorBtn = document.getElementById('moreEditorBtn');
    const editorMoreOptions = document.getElementById('editorMoreOptions');
    let moreDropdownVisible = false;

    // Show/hide more options dropdown
    moreEditorBtn.addEventListener('mousedown', function (e) {
        e.preventDefault();
        if (editorMoreOptions.style.display === 'block') {
            editorMoreOptions.style.display = 'none';
            moreDropdownVisible = false;
        } else {
            // Position dropdown below the button
            const rect = moreEditorBtn.getBoundingClientRect();
            editorMoreOptions.style.top = (rect.bottom + window.scrollY + 4) + 'px';
            editorMoreOptions.style.left = (rect.left + window.scrollX - 250) + 'px';
            editorMoreOptions.style.display = 'block';
            moreDropdownVisible = true;
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('mousedown', function (e) {
        if (
            editorMoreOptions.style.display === 'block' &&
            !editorMoreOptions.contains(e.target) &&
            !moreEditorBtn.contains(e.target)
        ) {
            editorMoreOptions.style.display = 'none';
            moreDropdownVisible = false;
        }
    });

    // --- Rename Document ---
    document.getElementById('renameMoreOptionsBtn').addEventListener('mousedown', function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        // Focus the title for editing
        const editableTitle = document.getElementById('editableTitle');
        if (editableTitle) {
            editableTitle.focus();
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(editableTitle);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    });

    // --- Version History ---
    document.getElementById('versionHistoryMoreOptionsBtn').addEventListener('mousedown', function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        versionHistoryBtn.click();
    });

    // --- Download Document (HTML) ---
    document.getElementById('downloadMoreOptionsBtn').addEventListener('mousedown', function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        // Download as HTML file
        const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
        const doc = documents.find(d => d.id === docId);
        if (!doc) return;
        const blob = new Blob([
            `<html><head><meta charset="UTF-8"><title>${doc.title}</title></head><body><h1>${doc.title}</h1>${doc.content}</body></html>`
        ], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (doc.title || 'document') + '.html';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            URL.revokeObjectURL(a.href);
            a.remove();
        }, 100);
        showToast('Document downloaded as HTML.', { type: 'success' });
    });

    // --- Compare Documents ---
    document.getElementById('compareMoreOptionsBtn').addEventListener('mousedown', function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        // Show modal to pick another document to compare
        const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
        const doc = documents.find(d => d.id === docId);
        if (!doc) return;
        // Modal
        let modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:700px;">
                <span class="modal-content-close" id="closeCompareModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                <h2>Compare Documents</h2>
                <div style="margin:18px 0;">
                    <label>Select document to compare:</label>
                    <select id="compareDocSelect" style="margin-left:8px;padding:6px 12px;border-radius:6px;">
                        ${documents.filter(d => d.id !== docId).map(d =>
                            `<option value="${d.id}">${d.title}</option>`
                        ).join('')}
                    </select>
                    <button id="compareDocsBtn" style="margin-left:12px;">Compare</button>
                </div>
                <div id="compareResult" style="margin-top:18px;max-height:300px;overflow:auto;"></div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#closeCompareModal').onclick = () => modal.remove();
        modal.querySelector('#compareDocsBtn').onclick = function () {
            const otherId = modal.querySelector('#compareDocSelect').value;
            const otherDoc = documents.find(d => d.id === otherId);
            if (!otherDoc) return;
            // Simple diff: highlight lines that differ
            function diffLines(a, b) {
                const aLines = (a || '').split('\n');
                const bLines = (b || '').split('\n');
                let html = '<div style="display:flex;gap:10px;"><div style="flex:1;"><b>This Document</b><br>';
                html += aLines.map((line, i) =>
                    `<div style="background:${bLines[i] !== line ? '#ffe06633' : 'transparent'};padding:2px 0;">${line}</div>`
                ).join('');
                html += '</div><div style="flex:1;"><b>Other Document</b><br>';
                html += bLines.map((line, i) =>
                    `<div style="background:${aLines[i] !== bLines[i] ? '#ffe06633' : 'transparent'};padding:2px 0;">${bLines[i] || ''}</div>`
                ).join('');
                html += '</div></div>';
                return html;
            }
            modal.querySelector('#compareResult').innerHTML = diffLines(doc.content, otherDoc.content);
        };
    });

    // --- Share Document (PDF) ---
    document.getElementById('shareMoreOptionsBtn').addEventListener('mousedown', function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        shareDocumentBtn.click();
    });
    document.getElementById('duplicateMoreOptionsBtn').addEventListener('mousedown', async function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        // Duplicate current document
        const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
        const doc = documents.find(d => d.id === docId);
        if (!doc) return;
        const newDoc = {
            id: 'doc-' + (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : Date.now() + '-' + Math.random().toString(36).substr(2, 9)),
            title: doc.title + ' (Copy)',
            content: doc.content,
            versions: doc.versions ? JSON.parse(JSON.stringify(doc.versions)) : []
        };
        documents.push(newDoc);
        addDocumentToList(newDoc);
        openDocument(newDoc.id);
        await saveDocuments();
        showToast('Document duplicated.', { type: 'success' });
    });
    // --- Delete Document ---
    document.getElementById('deleteMoreOptionsBtn').addEventListener('mousedown', async function (e) {
        e.preventDefault();
        editorMoreOptions.style.display = 'none';
        // Confirm delete
        let modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:400px;">
                <span class="modal-content-close" id="closeDeleteModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                <h2>Delete Document</h2>
                <p>Are you sure you want to delete this document? This cannot be undone.</p>
                <div style="margin-top:24px;display:flex;gap:12px;">
                    <button id="confirmDeleteBtn" style="background:#e74c3c;color:#fff;">Delete</button>
                    <button id="cancelDeleteBtn">Cancel</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#closeDeleteModal').onclick = () => modal.remove();
        modal.querySelector('#cancelDeleteBtn').onclick = () => modal.remove();
        modal.querySelector('#confirmDeleteBtn').onclick = async function () {
            const docId = window.location.hash.match(/^#\/document\/(.+)$/)?.[1];
            const idx = documents.findIndex(d => d.id === docId);
            if (idx !== -1) {
                documents.splice(idx, 1);
                // Remove from IndexedDB
                const tx = db.transaction(DOC_STORE, 'readwrite');
                tx.objectStore(DOC_STORE).delete(docId);
                // Remove from sidebar
                const el = document.querySelector(`.document-item[data-doc-id="${docId}"]`);
                if (el) el.remove();
                // Go back to select area
                window.location.hash = '';
                showToast('Document deleted.', { type: 'success' });
            }
            modal.remove();
        };
    });
    // --- Templates Logic ---
    // Define 20 templates
    const TEMPLATES = [
        { id: 'tpl-1', name: 'Blank', content: '' },
        { id: 'tpl-2', name: 'Meeting Notes', content: '<h1>Meeting Notes</h1><p>Date: <br>Attendees: <br>Agenda:</p><ul><li></li></ul><h2>Notes</h2><ul><li></li></ul>' },
        { id: 'tpl-3', name: 'Project Plan', content: '<h1>Project Plan</h1><h2>Overview</h2><p></p><h2>Milestones</h2><ul><li></li></ul><h2>Tasks</h2><ul><li></li></ul>' },
        { id: 'tpl-4', name: 'To-Do List', content: '<h1>To-Do List</h1><ul><li></li></ul>' },
        { id: 'tpl-5', name: 'Weekly Journal', content: '<h1>Weekly Journal</h1><h2>Monday</h2><p></p><h2>Tuesday</h2><p></p><h2>Wednesday</h2><p></p><h2>Thursday</h2><p></p><h2>Friday</h2><p></p>' },
        { id: 'tpl-6', name: 'Personal Diary', content: '<h1>Diary Entry</h1><p>Date: </p><p>Today I...</p>' },
        { id: 'tpl-7', name: 'Recipe', content: '<h1>Recipe Name</h1><h2>Ingredients</h2><ul><li></li></ul><h2>Instructions</h2><ol><li></li></ol>' },
        { id: 'tpl-8', name: 'Brainstorm', content: '<h1>Brainstorm Ideas</h1><ul><li></li></ul>' },
        { id: 'tpl-9', name: 'Book Summary', content: '<h1>Book Title</h1><h2>Author</h2><p></p><h2>Summary</h2><p></p>' },
        { id: 'tpl-10', name: 'Class Notes', content: '<h1>Class Notes</h1><p>Subject: <br>Date: </p><ul><li></li></ul>' },
        { id: 'tpl-11', name: 'Daily Planner', content: '<h1>Daily Planner</h1><h2>Morning</h2><ul><li></li></ul><h2>Afternoon</h2><ul><li></li></ul><h2>Evening</h2><ul><li></li></ul>' },
        { id: 'tpl-12', name: 'Travel Itinerary', content: '<h1>Travel Itinerary</h1><h2>Destination</h2><p></p><h2>Schedule</h2><ul><li></li></ul>' },
        { id: 'tpl-13', name: 'Workout Log', content: '<h1>Workout Log</h1><p>Date: </p><ul><li>Exercise: <br>Sets: <br>Reps: </li></ul>' },
        { id: 'tpl-14', name: 'Expense Tracker', content: '<h1>Expense Tracker</h1><table><tr><th>Date</th><th>Description</th><th>Amount</th></tr><tr><td></td><td></td><td></td></tr></table>' },
        { id: 'tpl-15', name: 'Contact List', content: '<h1>Contact List</h1><ul><li>Name: <br>Phone: <br>Email: </li></ul>' },
        { id: 'tpl-16', name: 'Event Agenda', content: '<h1>Event Agenda</h1><h2>Event</h2><p></p><h2>Schedule</h2><ul><li>Time: <br>Activity: </li></ul>' },
        { id: 'tpl-17', name: 'Job Application', content: '<h1>Job Application</h1><p>Position: <br>Company: <br>Why I am a good fit:</p>' },
        { id: 'tpl-18', name: 'Newsletter', content: '<h1>Newsletter Title</h1><h2>Issue</h2><p></p><h2>Highlights</h2><ul><li></li></ul>' },
        { id: 'tpl-19', name: 'Research Notes', content: '<h1>Research Notes</h1><h2>Topic</h2><p></p><h2>Findings</h2><ul><li></li></ul>' },
        { id: 'tpl-20', name: 'Simple Resume', content: '<h1>Your Name</h1><h2>Contact</h2><p>Email: <br>Phone: </p><h2>Experience</h2><ul><li></li></ul><h2>Education</h2><ul><li></li></ul>' }
    ];

    // Render templates list in #templatesList
    function renderTemplatesList() {
        const list = document.getElementById('templatesList');
        list.innerHTML = '';
        TEMPLATES.forEach((tpl, idx) => {
            const div = document.createElement('div');
            div.className = 'sidebarnav__item template-item';
            div.style.cursor = 'pointer';
            div.style.marginBottom = '8px';
            div.innerHTML = `<icon>description</icon><div class="menu-text">${tpl.name}</div>`;
            div.addEventListener('click', async () => {
                // Create a new document from template
                const newDoc = {
                    id: 'doc-' + (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : Date.now() + '-' + Math.random().toString(36).substr(2, 9)),
                    title: tpl.name + ' ' + new Date().toLocaleTimeString(),
                    content: tpl.content
                };
                documents.push(newDoc);
                addDocumentToList(newDoc);
                openDocument(newDoc.id);
                await saveDocuments();
            });
            list.appendChild(div);
        });
    }
    // --- Document Search Bar Functionality ---
    const searchBarInput = document.querySelector('.search-bar input');
    searchBarInput.addEventListener('input', function () {
        const query = this.value.trim().toLowerCase();
        const list = document.getElementById('documentsList');
        list.innerHTML = '';
        if (!query) {
            // Show all documents
            documents.forEach(doc => addDocumentToList(doc));
        } else {
            documents
                .filter(doc => doc.title && doc.title.toLowerCase().includes(query))
                .forEach(doc => addDocumentToList(doc));
        }
    });
    // Patch switchPage to render templates when needed
    (function patchTemplatesTabSwitch() {
        const origSwitchPage = switchPage;
        switchPage = function(pageId) {
            origSwitchPage(pageId);
            if (pageId === 'templatesApp') {
                renderTemplatesList();
            }
        };
    })();
    // Handle create document click
    document.querySelectorAll('#createOptions .dropdown-item')[0].addEventListener('click', async function() {
        // Hide dropdown
        document.getElementById('createOptions').style.display = 'none';
        // Create new doc
        const newDoc = {
            id: 'doc-' + (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : Date.now() + '-' + Math.random().toString(36).substr(2, 9)),
            title: 'Untitled Document'
        };
        documents.push(newDoc);
        addDocumentToList(newDoc);
        openDocument(newDoc.id);
        await saveDocuments();
    });
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const target = document.getElementById(pageId);
            if (target) target.classList.add('active');
        }

        // Hash-based navigation
        function handleHashChange() {
            const hash = window.location.hash;
            if (hash === '#/tasks') {
                switchPage('tasksApp');
            } else if (hash === '#/images') {
                switchPage('imagesApp');
            } else if (hash === '#/templates') {
                switchPage('templatesApp');
            } else {
                switchPage('selectArea');
            }
        }
        window.addEventListener('hashchange', handleHashChange);
        handleHashChange();

        // Sidebar navigation click handlers
        document.querySelectorAll('.sidebarnav__item').forEach((item, idx) => {
            item.addEventListener('click', () => {
                if (idx === 0) window.location.hash = '#/images';
                else if (idx === 1) window.location.hash = '#/tasks';
                else if (idx === 2) window.location.hash = '#/templates';
                else window.location.hash = '';
            });
        });

        // Logo/title click returns to selectArea
        document.querySelector('.sidebar__header h3').addEventListener('click', () => {
            window.location.hash = '';
        });
        // --- Import File Functionality ---
        // "Import File" is the third dropdown-item in #createOptions
        document.querySelectorAll('#createOptions .dropdown-item')[2].addEventListener('click', async function() {
            // Hide dropdown
            document.getElementById('createOptions').style.display = 'none';
            // Open file picker
            let input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.md,.docx,text/plain,text/markdown,application/vnd.openxmlformats-officedocument.wordprocessingml.document';
            input.onchange = async function(e) {
                const file = input.files[0];
                if (!file) return;
                let content = '';
                let title = file.name.replace(/\.[^/.]+$/, '');
                // Helper: create and open new doc
                async function createAndOpenDoc(content, title) {
                    const newDoc = {
                        id: 'doc-' + (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : Date.now() + '-' + Math.random().toString(36).substr(2, 9)),
                        title: title || 'Imported Document',
                        content: content
                    };
                    documents.push(newDoc);
                    addDocumentToList(newDoc);
                    openDocument(newDoc.id);
                    await saveDocuments();
                    showToast('File imported.', { type: 'success' });
                }
                // TXT/MD
                if (file.type === 'text/plain' || file.name.match(/\.(txt|md)$/i)) {
                    const reader = new FileReader();
                    reader.onload = async function(ev) {
                        let text = ev.target.result;
                        // If .md, convert to HTML (basic)
                        if (file.name.match(/\.md$/i)) {
                            // Basic markdown to HTML (headings, bold, italic, lists, code, links)
                            text = text
                                .replace(/^###### (.*)$/gim, '<h6>$1</h6>')
                                .replace(/^##### (.*)$/gim, '<h5>$1</h5>')
                                .replace(/^#### (.*)$/gim, '<h4>$1</h4>')
                                .replace(/^### (.*)$/gim, '<h3>$1</h3>')
                                .replace(/^## (.*)$/gim, '<h2>$1</h2>')
                                .replace(/^# (.*)$/gim, '<h1>$1</h1>')
                                .replace(/\*\*(.*?)\*\*/gim, '<b>$1</b>')
                                .replace(/\*(.*?)\*/gim, '<i>$1</i>')
                                .replace(/`([^`]+)`/gim, '<code>$1</code>')
                                .replace(/\n\* (.*)/gim, '<ul><li>$1</li></ul>')
                                .replace(/\n\d+\. (.*)/gim, '<ol><li>$1</li></ol>')
                                .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>')
                                .replace(/\n{2,}/g, '<br><br>');
                        } else {
                            // Plain text: wrap in <pre>
                            text = '<pre>' + text.replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])) + '</pre>';
                        }
                        await createAndOpenDoc(text, title);
                    };
                    reader.readAsText(file);
                }
              
                // DOCX
                else if (
                    file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                    file.name.match(/\.docx$/i)
                ) {
                    showToast('Importing DOCX...', { type: 'info' });
                    // Use mammoth.js via CDN
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js';
                    script.onload = function() {
                        const reader = new FileReader();
                        reader.onload = async function(ev) {
                            try {
                                window.mammoth.convertToHtml({arrayBuffer: ev.target.result})
                                    .then(async result => {
                                        await createAndOpenDoc(result.value, title);
                                    })
                                    .catch(() => showToast('Failed to import DOCX.', { type: 'error' }));
                            } catch (err) {
                                showToast('Failed to import DOCX.', { type: 'error' });
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    };
                    document.body.appendChild(script);
                }
                // Fallback: show error
                else {
                    showToast('Unsupported file type.', { type: 'error' });
                }
            };
            input.click();
        });
    let sidebarVisible = true;
    const sidebarContainer = document.querySelector('.sidebar__container');
    const mainContainer = document.querySelector('.main-container');
    const navbar = document.querySelector('.navbar');

    // Get all toggleSidebar buttons (there's one in each navbar)
    const toggleSidebarBtns = document.querySelectorAll('#toggleSidebar');

    function showSidebarOverlay() {
        sidebarContainer.style.position = 'fixed';
        sidebarContainer.style.left = '0';
        sidebarContainer.style.top = '0';
        sidebarContainer.style.zIndex = '10001';
        sidebarContainer.style.height = '100vh';
        sidebarContainer.style.background = 'rgba(17,7,54,0.98)';
        sidebarContainer.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.4)';
        sidebarContainer.style.transition = 'left 0.3s';
        sidebarContainer.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function hideSidebarOverlay() {
        sidebarContainer.style.left = '-600px';
        sidebarContainer.style.background = '';
        sidebarContainer.style.boxShadow = '';
        document.body.style.overflow = '';
    }

    function showSidebarDesktop() {
        sidebarContainer.style.position = '';
        sidebarContainer.style.left = '';
        sidebarContainer.style.top = '';
        sidebarContainer.style.zIndex = '';
        sidebarContainer.style.background = '';
        sidebarContainer.style.boxShadow = '';
        sidebarContainer.style.display = '';
        document.body.style.overflow = '';
    }

    function toggleSidebar() {
        const width = window.innerWidth;
        // Get all navbars (since there may be more than one)
        const navbars = document.querySelectorAll('.navbar');
        if (width > 1150) {
            // Desktop: toggle sidebar visibility
            if (sidebarVisible) {
                sidebarContainer.style.display = 'none';
                mainContainer.style.width = '100%';
                navbars.forEach(nb => nb.style.setProperty('width', '100%', 'important'));
                sidebarVisible = false;
            } else {
                sidebarContainer.style.display = '';
                mainContainer.style.width = 'calc(100% - 300px)';
                navbars.forEach(nb => nb.style.setProperty('width', 'calc(100% - 320px)', 'important'));
                sidebarVisible = true;
            }
        } else {
            // Mobile/tablet: overlay
            if (sidebarContainer.style.left === '0px') {
                hideSidebarOverlay();
            } else {
                showSidebarOverlay();
            }
        }
    }

    // Hide overlay sidebar when clicking outside (mobile/tablet)
    document.addEventListener('mousedown', function(event) {
        if (window.innerWidth <= 1150) {
            if (
                sidebarContainer.style.left === '0px' &&
                !sidebarContainer.contains(event.target) &&
                !Array.from(toggleSidebarBtns).some(btn => btn.contains(event.target))
            ) {
                hideSidebarOverlay();
            }
        }
    });

    // Reset sidebar on resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 1150) {
            showSidebarDesktop();
            sidebarVisible = true;
        } else {
            hideSidebarOverlay();
        }
    });

    // Attach toggleSidebar to all toggleSidebar buttons
    toggleSidebarBtns.forEach(btn => btn.addEventListener('click', toggleSidebar));

    // On load, ensure correct sidebar state
    if (window.innerWidth > 1150) {
        showSidebarDesktop();
        sidebarVisible = true;
    } else {
        hideSidebarOverlay();
    }

    // Hide sidebar overlay when switching content (mobile/tablet)
    function hideSidebarIfMobile() {
        if (window.innerWidth <= 1150) {
            hideSidebarOverlay();
        }
    }

    // Patch sidebar navigation click handlers to also hide overlay
    document.querySelectorAll('.sidebarnav__item').forEach((item, idx) => {
        item.addEventListener('click', () => {
            if (idx === 0) switchPage('imagesApp');
            else if (idx === 1) switchPage('tasksApp');
            else if (idx === 2) switchPage('templatesApp');
            else switchPage('selectArea');
            hideSidebarIfMobile();
        });
    });

    // Logo/title click returns to selectArea and hides overlay
    document.querySelector('.sidebar__header h3').addEventListener('click', () => {
        switchPage('selectArea');
        hideSidebarIfMobile();
    });
    // --- Images IndexedDB Store ---
    const IMAGE_STORE = 'images';
    const TRASH_STORE = 'trashImages';

    // Upgrade DB for images and trash
    (function patchDBForImages() {
        const origOpenDB = openDB;
        openDB = function() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION + 1);
                req.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(DOC_STORE)) {
                        db.createObjectStore(DOC_STORE, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(KEY_STORE)) {
                        db.createObjectStore(KEY_STORE, { keyPath: 'name' });
                    }
                    if (!db.objectStoreNames.contains(IMAGE_STORE)) {
                        db.createObjectStore(IMAGE_STORE, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(TRASH_STORE)) {
                        db.createObjectStore(TRASH_STORE, { keyPath: 'id', autoIncrement: true });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };
    })();

    // --- Images Logic ---
    let imagesTabMode = 'main'; // 'main' or 'trash'

    async function addImageToDB(file) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(IMAGE_STORE, 'readwrite');
            const store = tx.objectStore(IMAGE_STORE);
            const imgObj = {
                name: file.name,
                type: file.type,
                created: Date.now(),
                file
            };
            const req = store.add(imgObj);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function getAllImages(storeName = IMAGE_STORE) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function deleteImage(id, toTrash = true) {
        // Move to trash or delete permanently
        if (toTrash) {
            // Move to trash store
            const tx = db.transaction([IMAGE_STORE, TRASH_STORE], 'readwrite');
            const imgStore = tx.objectStore(IMAGE_STORE);
            const trashStore = tx.objectStore(TRASH_STORE);
            const getReq = imgStore.get(id);
            getReq.onsuccess = function() {
                if (getReq.result) {
                    trashStore.add(getReq.result);
                    imgStore.delete(id);
                }
            };
        } else {
            // Delete from trash
            const tx = db.transaction(TRASH_STORE, 'readwrite');
            tx.objectStore(TRASH_STORE).delete(id);
        }
    }

    async function restoreImageFromTrash(id) {
        // Move from trash to images
        const tx = db.transaction([IMAGE_STORE, TRASH_STORE], 'readwrite');
        const imgStore = tx.objectStore(IMAGE_STORE);
        const trashStore = tx.objectStore(TRASH_STORE);
        const getReq = trashStore.get(id);
        getReq.onsuccess = function() {
            if (getReq.result) {
                imgStore.add(getReq.result);
                trashStore.delete(id);
            }
        };
    }

    function renderImagesList() {
        const imagesList = document.getElementById('imagesList');
        imagesList.innerHTML = 'Loading...';
        const storeName = imagesTabMode === 'main' ? IMAGE_STORE : TRASH_STORE;
        getAllImages(storeName).then(images => {
            if (!images.length) {
                imagesList.innerHTML = imagesTabMode === 'main' ? 'No Images' : 'Trash is empty';
                return;
            }
            imagesList.innerHTML = '';
            images.forEach(img => {
                const url = URL.createObjectURL(img.file);
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '16px';
                div.style.marginBottom = '18px';
                div.style.background = 'rgba(255,255,255,0.04)';
                div.style.padding = '10px 16px';
                div.style.borderRadius = '12px';
                div.innerHTML = `
                    <img src="${url}" alt="${img.name}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;">
                    <div style="flex:1;">
                        <div style="font-size:16px;">${img.name}</div>
                        <div style="font-size:12px;opacity:0.7;">${new Date(img.created).toLocaleString()}</div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        ${
                            imagesTabMode === 'main'
                            ? `<button class="img-delete-btn" data-id="${img.id}" style="background:transparent;border:none;color:#fff;cursor:pointer;"><icon>delete</icon></button>`
                            : `<button class="img-restore-btn" data-id="${img.id}" style="background:transparent;border:none;color:#fff;cursor:pointer;"><icon>restore</icon></button>
                               <button class="img-delete-perm-btn" data-id="${img.id}" style="background:transparent;border:none;color:#fff;cursor:pointer;"><icon>delete_forever</icon></button>`
                        }
                    </div>
                `;
                imagesList.appendChild(div);
            });

            // Delete/restore handlers
            imagesList.querySelectorAll('.img-delete-btn').forEach(btn => {
                btn.onclick = async e => {
                    const id = Number(btn.getAttribute('data-id'));
                    await deleteImage(id, true);
                    renderImagesList();
                };
            });
            imagesList.querySelectorAll('.img-restore-btn').forEach(btn => {
                btn.onclick = async e => {
                    const id = Number(btn.getAttribute('data-id'));
                    await restoreImageFromTrash(id);
                    renderImagesList();
                };
            });
            imagesList.querySelectorAll('.img-delete-perm-btn').forEach(btn => {
                btn.onclick = async e => {
                    const id = Number(btn.getAttribute('data-id'));
                    await deleteImage(id, false);
                    renderImagesList();
                };
            });
        });
    }
    // --- Upload Image from Create Options ---
    // "New Image" is the second dropdown-item in #createOptions
    document.querySelectorAll('#createOptions .dropdown-item')[1].addEventListener('click', async function() {
        // Hide dropdown
        document.getElementById('createOptions').style.display = 'none';
        // Open file picker
        let input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(e) {
            const file = input.files[0];
            if (file) {
                await addImageToDB(file);
                // Switch to images tab and refresh list
                window.location.hash = '#/images';
                imagesTabMode = 'main';
                renderImagesList();
                showToast('Image uploaded and added to library.', { type: 'success' });
            }
        };
        input.click();
    });
    // --- Upload Image Button ---
    document.getElementById('uploadImageBtn').addEventListener('click', function() {
        let input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(e) {
            const file = input.files[0];
            if (file) {
                await addImageToDB(file);
                renderImagesList();
            }
        };
        input.click();
    });

    // --- More Images Button (Trash) ---
    let imagesMoreDropdown = null;
    document.getElementById('moreImagesBtn').addEventListener('click', function(e) {
        if (imagesMoreDropdown) {
            imagesMoreDropdown.remove();
            imagesMoreDropdown = null;
            return;
        }
        imagesMoreDropdown = document.createElement('div');
        imagesMoreDropdown.className = 'dropdown-wrapper liquid-glass';
        imagesMoreDropdown.style.position = 'absolute';
        imagesMoreDropdown.style.minWidth = '120px';
        imagesMoreDropdown.style.top = (e.target.getBoundingClientRect().bottom + window.scrollY - 40) + 'px';
        imagesMoreDropdown.style.left = (e.target.getBoundingClientRect().left + window.scrollX - 150) + 'px';
        imagesMoreDropdown.style.display = 'block';
        imagesMoreDropdown.innerHTML = `
            <div class="dropdown-item" id="viewTrashImages"><icon>delete</icon><div class="menu-text">View Trash</div></div>
            <div class="dropdown-item" id="viewMainImages" style="display:${imagesTabMode === 'trash' ? 'flex' : 'none'}"><icon>photo_library</icon><div class="menu-text">Back to Images</div></div>
        `;
        document.body.appendChild(imagesMoreDropdown);

        imagesMoreDropdown.querySelector('#viewTrashImages').onclick = () => {
            imagesTabMode = 'trash';
            renderImagesList();
            imagesMoreDropdown.remove();
            imagesMoreDropdown = null;
        };
        imagesMoreDropdown.querySelector('#viewMainImages').onclick = () => {
            imagesTabMode = 'main';
            renderImagesList();
            imagesMoreDropdown.remove();
            imagesMoreDropdown = null;
        };
    });

    // Hide dropdown when clicking outside
    document.addEventListener('mousedown', function(event) {
        if (imagesMoreDropdown && !imagesMoreDropdown.contains(event.target) && event.target.id !== 'moreImagesBtn') {
            imagesMoreDropdown.remove();
            imagesMoreDropdown = null;
        }
    });

    // Render images list when switching to images tab
    function patchImagesTabSwitch() {
        const origSwitchPage = switchPage;
        switchPage = function(pageId) {
            origSwitchPage(pageId);
            if (pageId === 'imagesApp') {
                imagesTabMode = 'main';
                renderImagesList();
            }
        };
    }
    patchImagesTabSwitch();
        document.getElementById('createBtn').addEventListener('click', function(event) {
            const createOptions = document.getElementById('createOptions');
            if (createOptions.style.display === 'block') {
                createOptions.style.display = 'none';
            } else {
                // Get the button's position
                const rect = event.target.getBoundingClientRect();
                // Set dropdown position relative to viewport
                createOptions.style.top = (rect.bottom + window.scrollY - 50) + 'px';
                createOptions.style.left = (rect.left + window.scrollX - 120) + 'px';
                createOptions.style.display = 'block';
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('mousedown', function(event) {
            const createOptions = document.getElementById('createOptions');
            const createBtn = document.getElementById('createBtn');
            if (
                createOptions.style.display === 'block' &&
                !createOptions.contains(event.target) &&
                !createBtn.contains(event.target)
            ) {
                createOptions.style.display = 'none';
            }
        });
        /**
         * Show a toast notification at the bottom center of the screen.
         * @param {string} message - The message to display.
         * @param {object} [options] - Optional settings: { duration: ms, type: 'success'|'error'|'info' }
         */
        function showToast(message, options = {}) {
            // Remove any existing toast
            const old = document.getElementById('omniwrite-toast');
            if (old) old.remove();

            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'omniwrite-toast';
            toast.className = 'liquid-glass';
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.left = '50%';
            toast.style.bottom = '40px';
            toast.style.transform = 'translateX(-50%)';
            toast.style.padding = '14px 32px';
            toast.style.fontSize = '16px';
            toast.style.zIndex = 999999;
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.2s';

            // Set background color based on type
            let bg = 'rgba(30,30,40,0.92)';
            let color = '#fff';
            if (options.type === 'success') {
                bg = 'rgba(46, 204, 113, 0.88)';
                color = '#fff';
            } else if (options.type === 'error') {
                bg = 'rgba(231, 76, 60, 0.88)';
                color = '#fff';
            } else if (options.type === 'info') {
                bg = 'rgba(52, 152, 219, 0.88)';
                color = '#fff';
            }
            toast.style.background = bg;
            toast.style.color = color;

            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            // Remove after duration
            const duration = typeof options.duration === 'number' ? options.duration : 2600;
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        /**
         * Help Modal Functionality
         */
        const helpItem = document.querySelector('.help-item');
        let helpModal = null;

        helpItem.addEventListener('click', function () {
            // Remove any existing modal
            document.querySelectorAll('.modal').forEach(m => m.remove());
            helpModal = null;

            // Create modal
            helpModal = document.createElement('div');
            helpModal.className = 'modal';
            helpModal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:600px;">
                <span class="modal-content-close" id="closeHelpModal" style="position:absolute;top:18px;right:24px;cursor:pointer;font-size:28px;z-index:2;">&times;</span>
                <h2>Help</h2>
                <div style="margin:18px 0;">
                    <h3>How To</h3>
                    <ul>
                        <li>Create a new document: Click the <b>+</b> button or "New Document".</li>
                        <li>Edit your document: Use the toolbar for formatting, images, tables, and more.</li>
                        <li>Switch tabs: Use the sidebar for Images, Tasks, and Templates.</li>
                        <li>Save: All changes are saved automatically and encrypted locally.</li>
                        <li>Export/Import: Use Settings &gt; Backup & Restore to export or import your data.</li>
                    </ul>
                    <h3>FAQ</h3>
                    <ul>
                        <li><b>Where are my documents stored?</b><br>All data is stored locally in your browser using encrypted IndexedDB.</li>
                        <li><b>Can I use this offline?</b><br>Yes, OmniWrite works offline after the first load.</li>
                        <li><b>How do I restore a backup?</b><br>Go to Settings &gt; Import Backup and select your backup file.</li>
                        <li><b>How do I change the language or theme?</b><br>Go to Settings and select your preferred language or theme.</li>
                    </ul>
                    <h3>Copyright</h3>
                    <div style="font-size:14px;opacity:0.7;margin-top:8px;">
                        &copy; 2025-2026 Munetios.<br>
                        Munetios OmniWrite is a unregistered trademark of Munetios.<br>
                        Website <a href="https://munetios.com" target="_blank" style="color:#ffe066;">munetios.com</a>
                    <br>OmniWrite is open source. See <a href="https://github.com/munetios/omniwrite" target="_self" style="color:#ffe066;">github.com/munetios/omniwrite</a><br>
                    </div>
                </div>
            </div>
            `;
            document.body.appendChild(helpModal);

            // Close modal
            helpModal.querySelector('#closeHelpModal').onclick = () => {
                helpModal.remove();
                helpModal = null;
            };
        });
        /**
         * Settings Modal Functionality
         */
        const settingsItem = document.querySelector('.settings-item');
        let settingsModal = null;

        // Move applyTheme and applyTranslations to global scope
        function applyTheme(theme) {
            if (theme === 'system') {
                document.body.style.background = '';
                document.body.style.color = '';
            } else if (theme === 'light') {
                document.body.style.background = '#fff';
                document.body.style.color = '#222';
                document.querySelectorAll('button').forEach(btn => btn.style.color = '#222');
            } else if (theme === 'dark') {
                document.body.style.background = '#110736';
                document.body.style.color = '#fff';
            } else if (theme === 'custom') {
                // Only set colors, do NOT open modal on load
                document.body.style.background = localStorage.getItem('omniwrite-custom-bg') || '#2c2c54';
                document.body.style.color = localStorage.getItem('omniwrite-custom-text') || '#ffe066';
            }
        }
        
        // TRANSLATIONS dictionary and applyTranslations function should be defined outside settingsItem click handler
        const TRANSLATIONS = {
            en: {
                'Welcome to Munetios OmniWrite': 'Welcome to Munetios OmniWrite',
                'Select or create a new document to get started.': 'Select or create a new document to get started.',
                'Images': 'Images',
                'Tasks': 'Tasks',
                'Templates': 'Templates',
                'Settings': 'Settings',
                'Help': 'Help',
                'New Document': 'New Document',
                'New Image': 'New Image',
                'Import File': 'Import File',
                'Upload Image': 'Upload Image',
                'Download': 'Download',
                'Make a Copy': 'Make a Copy',
                'Compare Documents': 'Compare Documents',
                'Share': 'Share',
                'Delete': 'Delete',
                'Rename Document': 'Rename Document',
                'Version History': 'Version History',
                'Table of Contents': 'Table of Contents',
                'No Images': 'No Images',
                'Trash is empty': 'Trash is empty',
                'View Trash': 'View Trash',
                'Back to Images': 'Back to Images',
                'Theme:': 'Theme:',
                'Language:': 'Language:',
                'Backup & Restore': 'Backup & Restore',
                'Export Backup': 'Export Backup',
                'Import Backup': 'Import Backup',
                'Danger Zone': 'Danger Zone',
                'Reset Encryption Key': 'Reset Encryption Key',
                'Delete Everything': 'Delete Everything',
                'Delete Document': 'Delete Document',
                'Are you sure you want to delete this document? This cannot be undone.': 'Are you sure you want to delete this document? This cannot be undone.',
                'Cancel': 'Cancel',
                'Restore This Version': 'Restore This Version',
                'Share this document with others by downloading it as a PDF file.': 'Share this document with others by downloading it as a PDF file.',
                'Download as PDF': 'Download as PDF',
                'Download a PDF version of this document.': 'Download a PDF version of this document.',
                'No versions saved yet.': 'No versions saved yet.',
                'No headings found to build Table of Contents.': 'No headings found to build Table of Contents.',
                'File imported.': 'File imported.',
                'Image inserted and added to library.': 'Image inserted and added to library.',
                'Image uploaded and added to library.': 'Image uploaded and added to library.',
                'Document duplicated.': 'Document duplicated.',
                'Document deleted.': 'Document deleted.',
                'Backup exported.': 'Backup exported.',
                'Backup imported.': 'Backup imported.',
                'Invalid backup file.': 'Invalid backup file.',
                'Failed to import backup.': 'Failed to import backup.',
                'Encryption key reset. All documents deleted.': 'Encryption key reset. All documents deleted.',
                'All data deleted.': 'All data deleted.',
                'Theme updated.': 'Theme updated.',
                'Language updated.': 'Language updated.',
                'Print dialog opened. Choose "Save as PDF" to download.': 'Print dialog opened. Choose "Save as PDF" to download.',
                'Document downloaded as HTML.': 'Document downloaded as HTML.',
                'Unsupported file type.': 'Unsupported file type.',
                'Failed to import DOCX.': 'Failed to import DOCX.',
                'Importing DOCX...': 'Importing DOCX...',
                'Please enter a valid image URL.': 'Please enter a valid image URL.',
            },
            es: {
                'Welcome to Munetios OmniWrite': 'Bienvenido a Munetios OmniWrite',
                'Select or create a new document to get started.': 'Seleccione o cree un nuevo documento para comenzar.',
                'Images': 'Imgenes',
                'Tasks': 'Tareas',
                'Templates': 'Plantillas',
                'Settings': 'Configuracin',
                'Help': 'Ayuda',
                'New Document': 'Nuevo Documento',
                'New Image': 'Nueva Imagen',
                'Import File': 'Importar Archivo',
                'Upload Image': 'Subir Imagen',
                'Download': 'Descargar',
                'Make a Copy': 'Hacer una copia',
                'Compare Documents': 'Comparar Documentos',
                'Share': 'Compartir',
                'Delete': 'Eliminar',
                'Rename Document': 'Renombrar Documento',
                'Version History': 'Historial de Versiones',
                'Table of Contents': 'Tabla de Contenidos',
                'No Images': 'Sin Imgenes',
                'Trash is empty': 'La papelera est vaca',
                'View Trash': 'Ver Papelera',
                'Back to Images': 'Volver a Imgenes',
                'Theme:': 'Tema:',
                'Language:': 'Idioma:',
                'Backup & Restore': 'Respaldo y Restauracin',
                'Export Backup': 'Exportar Respaldo',
                'Import Backup': 'Importar Respaldo',
                'Danger Zone': 'Zona de Peligro',
                'Reset Encryption Key': 'Restablecer Clave de Encriptacin',
                'Delete Everything': 'Eliminar Todo',
                'Delete Document': 'Eliminar Documento',
                'Are you sure you want to delete this document? This cannot be undone.': 'Est seguro de que desea eliminar este documento? Esto no se puede deshacer.',
                'Cancel': 'Cancelar',
                'Restore This Version': 'Restaurar Esta Versin',
                'Share this document with others by downloading it as a PDF file.': 'Comparta este documento con otros descargndolo como archivo PDF.',
                'Download as PDF': 'Descargar como PDF',
                'Download a PDF version of this document.': 'Descargue una versin PDF de este documento.',
                'No versions saved yet.': 'No hay versiones guardadas an.',
                'No headings found to build Table of Contents.': 'No se encontraron encabezados para construir la tabla de contenidos.',
                'File imported.': 'Archivo importado.',
                'Image inserted and added to library.': 'Imagen insertada y agregada a la biblioteca.',
                'Image uploaded and added to library.': 'Imagen subida y agregada a la biblioteca.',
                'Document duplicated.': 'Documento duplicado.',
                'Document deleted.': 'Documento eliminado.',
                'Backup exported.': 'Respaldo exportado.',
                'Backup imported.': 'Respaldo importado.',
                'Invalid backup file.': 'Archivo de respaldo invlido.',
                'Failed to import backup.': 'Error al importar respaldo.',
                'Encryption key reset. All documents deleted.': 'Clave de encriptacin restablecida. Todos los documentos eliminados.',
                'All data deleted.': 'Todos los datos eliminados.',
                'Theme updated.': 'Tema actualizado.',
                'Language updated.': 'Idioma actualizado.',
                'Print dialog opened. Choose "Save as PDF" to download.': 'Dilogo de impresin abierto. Elija "Guardar como PDF" para descargar.',
                'Document downloaded as HTML.': 'Documento descargado como HTML.',
                'Unsupported file type.': 'Tipo de archivo no soportado.',
                'Failed to import DOCX.': 'Error al importar DOCX.',
                'Importing DOCX...': 'Importando DOCX...',
                'Please enter a valid image URL.': 'Por favor, ingrese una URL de imagen vlida.',
            },
            fr: {
                'Welcome to Munetios OmniWrite': 'Bienvenue sur Munetios OmniWrite',
                'Select or create a new document to get started.': 'Slectionnez ou crez un nouveau document pour commencer.',
                'Images': 'Images',
                'Tasks': 'Tches',
                'Templates': 'Modles',
                'Settings': 'Paramtres',
                'Help': 'Aide',
                'New Document': 'Nouveau Document',
                'New Image': 'Nouvelle Image',
                'Import File': 'Importer un fichier',
                'Upload Image': 'Tlcharger une image',
                'Download': 'Tlcharger',
                'Make a Copy': 'Faire une copie',
                'Compare Documents': 'Comparer les documents',
                'Share': 'Partager',
                'Delete': 'Supprimer',
                'Rename Document': 'Renommer le document',
                'Version History': 'Historique des versions',
                'Table of Contents': 'Table des matires',
                'No Images': 'Aucune image',
                'Trash is empty': 'La corbeille est vide',
                'View Trash': 'Voir la corbeille',
                'Back to Images': 'Retour aux images',
                'Theme:': 'Thme :',
                'Language:': 'Langue :',
                'Backup & Restore': 'Sauvegarde et restauration',
                'Export Backup': 'Exporter la sauvegarde',
                'Import Backup': 'Importer la sauvegarde',
                'Danger Zone': 'Zone dangereuse',
                'Reset Encryption Key': 'Rinitialiser la cl de chiffrement',
                'Delete Everything': 'Tout supprimer',
                'Delete Document': 'Supprimer le document',
                'Are you sure you want to delete this document? This cannot be undone.': 'tes-vous sr de vouloir supprimer ce document ? Cette action est irrversible.',
                'Cancel': 'Annuler',
                'Restore This Version': 'Restaurer cette version',
                'Share this document with others by downloading it as a PDF file.': 'Partagez ce document en le tlchargeant au format PDF.',
                'Download as PDF': 'Tlcharger en PDF',
                'Download a PDF version of this document.': 'Tlchargez une version PDF de ce document.',
                'No versions saved yet.': 'Aucune version enregistre.',
                'No headings found to build Table of Contents.': 'Aucun titre trouv pour crer la table des matires.',
                'File imported.': 'Fichier import.',
                'Image inserted and added to library.': 'Image insre et ajoute  la bibliothque.',
                'Image uploaded and added to library.': 'Image tlcharge et ajoute  la bibliothque.',
                'Document duplicated.': 'Document dupliqu.',
                'Document deleted.': 'Document supprim.',
                'Backup exported.': 'Sauvegarde exporte.',
                'Backup imported.': 'Sauvegarde importe.',
                'Invalid backup file.': 'Fichier de sauvegarde invalide.',
                'Failed to import backup.': 'chec de l\'importation de la sauvegarde.',
                'Encryption key reset. All documents deleted.': 'Cl de chiffrement rinitialise. Tous les documents ont t supprims.',
                'All data deleted.': 'Toutes les donnes ont t supprimes.',
                'Theme updated.': 'Thme mis  jour.',
                'Language updated.': 'Langue mise  jour.',
                'Print dialog opened. Choose "Save as PDF" to download.': 'Dialogue d\'impression ouvert. Choisissez "Enregistrer en PDF" pour tlcharger.',
                'Document downloaded as HTML.': 'Document tlcharg en HTML.',
                'Unsupported file type.': 'Type de fichier non pris en charge.',
                'Failed to import DOCX.': 'chec de l\'importation du DOCX.',
                'Importing DOCX...': 'Importation du DOCX...',
                'Please enter a valid image URL.': 'Veuillez entrer une URL d\'image valide.',
            },
            de: {
                'Welcome to Munetios OmniWrite': 'Willkommen bei Munetios OmniWrite',
                'Select or create a new document to get started.': 'Whlen Sie ein Dokument aus oder erstellen Sie ein neues, um zu beginnen.',
                'Images': 'Bilder',
                'Tasks': 'Aufgaben',
                'Templates': 'Vorlagen',
                'Settings': 'Einstellungen',
                'Help': 'Hilfe',
                'New Document': 'Neues Dokument',
                'New Image': 'Neues Bild',
                'Import File': 'Datei importieren',
                'Upload Image': 'Bild hochladen',
                'Download': 'Herunterladen',
                'Make a Copy': 'Kopie erstellen',
                'Compare Documents': 'Dokumente vergleichen',
                'Share': 'Teilen',
                'Delete': 'Lschen',
                'Rename Document': 'Dokument umbenennen',
                'Version History': 'Versionsverlauf',
                'Table of Contents': 'Inhaltsverzeichnis',
                'No Images': 'Keine Bilder',
                'Trash is empty': 'Papierkorb ist leer',
                'View Trash': 'Papierkorb anzeigen',
                'Back to Images': 'Zurck zu Bildern',
                'Theme:': 'Thema:',
                'Language:': 'Sprache:',
                'Backup & Restore': 'Backup & Wiederherstellung',
                'Export Backup': 'Backup exportieren',
                'Import Backup': 'Backup importieren',
                'Danger Zone': 'Gefahrenzone',
                'Reset Encryption Key': 'Verschlsselungsschlssel zurcksetzen',
                'Delete Everything': 'Alles lschen',
                'Delete Document': 'Dokument lschen',
                'Are you sure you want to delete this document? This cannot be undone.': 'Sind Sie sicher, dass Sie dieses Dokument lschen mchten? Dies kann nicht rckgngig gemacht werden.',
                'Cancel': 'Abbrechen',
                'Restore This Version': 'Diese Version wiederherstellen',
                'Share this document with others by downloading it as a PDF file.': 'Teilen Sie dieses Dokument, indem Sie es als PDF herunterladen.',
                'Download as PDF': 'Als PDF herunterladen',
                'Download a PDF version of this document.': 'Laden Sie eine PDF-Version dieses Dokuments herunter.',
                'No versions saved yet.': 'Noch keine Versionen gespeichert.',
                'No headings found to build Table of Contents.': 'Keine berschriften fr das Inhaltsverzeichnis gefunden.',
                'File imported.': 'Datei importiert.',
                'Image inserted and added to library.': 'Bild eingefgt und zur Bibliothek hinzugefgt.',
                'Image uploaded and added to library.': 'Bild hochgeladen und zur Bibliothek hinzugefgt.',
                'Document duplicated.': 'Dokument dupliziert.',
                'Document deleted.': 'Dokument gelscht.',
                'Backup exported.': 'Backup exportiert.',
                'Backup imported.': 'Backup importiert.',
                'Invalid backup file.': 'Ungltige Backup-Datei.',
                'Failed to import backup.': 'Backup konnte nicht importiert werden.',
                'Encryption key reset. All documents deleted.': 'Verschlsselungsschlssel zurckgesetzt. Alle Dokumente gelscht.',
                'All data deleted.': 'Alle Daten gelscht.',
                'Theme updated.': 'Thema aktualisiert.',
                'Language updated.': 'Sprache aktualisiert.',
                'Print dialog opened. Choose "Save as PDF" to download.': 'Druckdialog geffnet. Whlen Sie "Als PDF speichern" zum Herunterladen.',
                'Document downloaded as HTML.': 'Dokument als HTML heruntergeladen.',
                'Unsupported file type.': 'Nicht untersttzter Dateityp.',
                'Failed to import DOCX.': 'DOCX konnte nicht importiert werden.',
                'Importing DOCX...': 'DOCX wird importiert...',
                'Please enter a valid image URL.': 'Bitte geben Sie eine gltige Bild-URL ein.',
            },
            zh: {
                'Welcome to Munetios OmniWrite': ' Munetios OmniWrite',
                'Select or create a new document to get started.': '',
                'Images': '',
                'Tasks': '',
                'Templates': '',
                'Settings': '',
                'Help': '',
                'New Document': '',
                'New Image': '',
                'Import File': '',
                'Upload Image': '',
                'Download': '',
                'Make a Copy': '',
                'Compare Documents': '',
                'Share': '',
                'Delete': '',
                'Rename Document': '',
                'Version History': '',
                'Table of Contents': '',
                'No Images': '',
                'Trash is empty': '',
                'View Trash': '',
                'Back to Images': '',
                'Theme:': '',
                'Language:': '',
                'Backup & Restore': '',
                'Export Backup': '',
                'Import Backup': '',
                'Danger Zone': '',
                'Reset Encryption Key': '',
                'Delete Everything': '',
                'Delete Document': '',
                'Are you sure you want to delete this document? This cannot be undone.': '',
                'Cancel': '',
                'Restore This Version': '',
                'Share this document with others by downloading it as a PDF file.': ' PDF ',
                'Download as PDF': ' PDF',
                'Download a PDF version of this document.': ' PDF ',
                'No versions saved yet.': '',
                'No headings found to build Table of Contents.': '',
                'File imported.': '',
                'Image inserted and added to library.': '',
                'Image uploaded and added to library.': '',
                'Document duplicated.': '',
                'Document deleted.': '',
                'Backup exported.': '',
                'Backup imported.': '',
                'Invalid backup file.': '',
                'Failed to import backup.': '',
                'Encryption key reset. All documents deleted.': '',
                'All data deleted.': '',
                'Theme updated.': '',
                'Language updated.': '',
                'Print dialog opened. Choose "Save as PDF" to download.': ' PDF',
                'Document downloaded as HTML.': ' HTML',
                'Unsupported file type.': '',
                'Failed to import DOCX.': 'DOCX ',
                'Importing DOCX...': ' DOCX...',
                'Please enter a valid image URL.': '',
            },
            ja: {
                'Welcome to Munetios OmniWrite': 'Munetios OmniWrite ',
                'Select or create a new document to get started.': '',
                'Images': '',
                'Tasks': '',
                'Templates': '',
                'Settings': '',
                'Help': '',
                'New Document': '',
                'New Image': '',
                'Import File': '',
                'Upload Image': '',
                'Download': '',
                'Make a Copy': '',
                'Compare Documents': '',
                'Share': '',
                'Delete': '',
                'Rename Document': '',
                'Version History': '',
                'Table of Contents': '',
                'No Images': '',
                'Trash is empty': '',
                'View Trash': '',
                'Back to Images': '',
                'Theme:': '',
                'Language:': '',
                'Backup & Restore': '',
                'Export Backup': '',
                'Import Backup': '',
                'Danger Zone': '',
                'Reset Encryption Key': '',
                'Delete Everything': '',
                'Delete Document': '',
                'Are you sure you want to delete this document? This cannot be undone.': '',
                'Cancel': '',
                'Restore This Version': '',
                'Share this document with others by downloading it as a PDF file.': 'PDF',
                'Download as PDF': 'PDF',
                'Download a PDF version of this document.': 'PDF',
                'No versions saved yet.': '',
                'No headings found to build Table of Contents.': '',
                'File imported.': '',
                'Image inserted and added to library.': '',
                'Image uploaded and added to library.': '',
                'Document duplicated.': '',
                'Document deleted.': '',
                'Backup exported.': '',
                'Backup imported.': '',
                'Invalid backup file.': '',
                'Failed to import backup.': '',
                'Encryption key reset. All documents deleted.': '',
                'All data deleted.': '',
                'Theme updated.': '',
                'Language updated.': '',
                'Print dialog opened. Choose "Save as PDF" to download.': 'PDF',
                'Document downloaded as HTML.': 'HTML',
                'Unsupported file type.': '',
                'Failed to import DOCX.': 'DOCX',
                'Importing DOCX...': 'DOCX...',
                'Please enter a valid image URL.': 'URL',
            },
        };
        
        function applyTranslations(lang) {
            const dict = TRANSLATIONS[lang] || TRANSLATIONS['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) el.textContent = dict[key];
            });
            document.querySelectorAll('.sidebarnav__item .menu-text').forEach(el => {
                if (dict[el.textContent]) el.textContent = dict[el.textContent];
            });
            document.querySelectorAll('#createOptions .menu-text').forEach(el => {
                if (dict[el.textContent]) el.textContent = dict[el.textContent];
            });
            document.querySelectorAll('.modal-content label, .modal-content b, .modal-content h2, .modal-content h3, .modal-content h1, .modal-content h4, .modal-content h5, .modal-content h6').forEach(el => {
                if (dict[el.textContent]) el.textContent = dict[el.textContent];
            });
            document.querySelectorAll('button, .modal-content-close').forEach(el => {
                if (dict[el.textContent]) el.textContent = dict[el.textContent];
            });
            window.showToast = function(message, options = {}) {
                const msg = dict[message] || message;
                const old = document.getElementById('omniwrite-toast');
                if (old) old.remove();
                const toast = document.createElement('div');
                toast.id = 'omniwrite-toast';
                toast.className = 'liquid-glass';
                toast.textContent = msg;
                toast.style.position = 'fixed';
                toast.style.left = '50%';
                toast.style.bottom = '40px';
                toast.style.transform = 'translateX(-50%)';
                toast.style.padding = '14px 32px';
                toast.style.fontSize = '16px';
                toast.style.zIndex = 999999;
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.2s';
                let bg = 'rgba(30,30,40,0.92)';
                let color = '#fff';
                if (options.type === 'success') {
                    bg = 'rgba(46, 204, 113, 0.88)';
                    color = '#fff';
                } else if (options.type === 'error') {
                    bg = 'rgba(231, 76, 60, 0.88)';
                    color = '#fff';
                } else if (options.type === 'info') {
                    bg = 'rgba(52, 152, 219, 0.88)';
                    color = '#fff';
                }
                toast.style.background = bg;
                toast.style.color = color;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                const duration = typeof options.duration === 'number' ? options.duration : 2600;
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            };
        }
        
        // On page load, apply theme and translations from localStorage
        applyTheme(localStorage.getItem('omniwrite-theme') || 'system');
        applyTranslations(localStorage.getItem('omniwrite-lang') || 'en');
        
        settingsItem.addEventListener('click', function () {
            // Remove any existing modal
            document.querySelectorAll('.modal').forEach(m => m.remove());
            settingsModal = null;
        
            // Create modal
            settingsModal = document.createElement('div');
            settingsModal.className = 'modal';
            settingsModal.innerHTML = `
            <div class="modal-content" style="position:relative;max-width:520px;">
                <span class="modal-content-close" id="closeSettingsModal" style="position:absolute;top:18px;right:24px;cursor:pointer;font-size:28px;z-index:2;">&times;</span>
                <h2>Settings</h2>
                <div style="margin:24px 0;">
                    <label style="display:block;margin-bottom:12px;">
                        <b>Theme:</b>
                        <select id="themeSelect" style="margin-left:8px;padding:6px 12px;border-radius:6px;">
                            <option value="system">System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="custom">Custom</option>
                        </select>
                    </label>
                    <label style="display:block;margin-bottom:12px;">
                        <b>Language:</b>
                        <select id="languageSelect" style="margin-left:8px;padding:6px 12px;border-radius:6px;">
                            <option value="en">English</option>
                            <option value="es">Espaol</option>
                            <option value="fr">Franais</option>
                            <option value="de">Deutsch</option>
                            <option value="zh"></option>
                            <option value="ja"></option>
                        </select>
                    </label>
                </div>
                <div style="margin:24px 0;">
                    <b>Backup & Restore</b>
                    <div style="margin-top:12px;display:flex;gap:12px;">
                        <button id="exportBackupBtn"><icon>download</icon> Export Backup</button>
                        <button id="importBackupBtn"><icon>upload_file</icon> Import Backup</button>
                    </div>
                    <input type="file" id="importBackupInput" style="display:none;" accept="application/json">
                </div>
                <div style="margin:32px 0 0 0;border-top:1px solid #ffe06633;padding-top:18px;">
                    <b style="color:#e74c3c;">Danger Zone</b>
                    <div style="margin-top:12px;display:flex;flex-direction:column;gap:12px;">
                        <button id="resetKeyBtn" style="background:#ffe066;color:#110736;">Reset Encryption Key</button>
                        <button id="deleteEverythingBtn" style="background:#e74c3c;color:#fff;">Delete Everything</button>
                    </div>
                </div>
            </div>
            `;
            document.body.appendChild(settingsModal);
        
            // Close modal
            settingsModal.querySelector('#closeSettingsModal').onclick = () => {
                settingsModal.remove();
                settingsModal = null;
            };
        
            // Theme select logic
            const themeSelect = settingsModal.querySelector('#themeSelect');
            themeSelect.value = localStorage.getItem('omniwrite-theme') || 'system';
            themeSelect.onchange = function () {
                localStorage.setItem('omniwrite-theme', this.value);
                applyTheme(this.value);
                showToast('Theme updated.', { type: 'success' });
                // If custom selected, open modal for custom theme
                if (this.value === 'custom') {
                    let customModal = document.getElementById('customThemeModal');
                    if (!customModal) {
                        customModal = document.createElement('div');
                        customModal.id = 'customThemeModal';
                        customModal.className = 'modal';
                        customModal.innerHTML = `
                            <div class="modal-content" style="position:relative;max-width:340px;">
                                <span class="modal-content-close" id="closeCustomThemeModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                                <h2>Custom Theme</h2>
                                <label style="display:block;margin-bottom:12px;">
                                    Background Color:
                                    <input type="color" id="customBgColor" value="${localStorage.getItem('omniwrite-custom-bg') || '#2c2c54'}" style="margin-left:8px;">
                                </label>
                                <label style="display:block;margin-bottom:18px;">
                                    Text Color:
                                    <input type="color" id="customTextColor" value="${localStorage.getItem('omniwrite-custom-text') || '#ffe066'}" style="margin-left:8px;">
                                </label>
                                <button id="applyCustomThemeBtn" style="margin-top:12px;">Apply</button>
                            </div>
                        `;
                        document.body.appendChild(customModal);
                        customModal.querySelector('#closeCustomThemeModal').onclick = () => customModal.remove();
                        customModal.querySelector('#applyCustomThemeBtn').onclick = function () {
                            const bg = customModal.querySelector('#customBgColor').value;
                            const text = customModal.querySelector('#customTextColor').value;
                            localStorage.setItem('omniwrite-custom-bg', bg);
                            localStorage.setItem('omniwrite-custom-text', text);
                            document.body.style.background = bg;
                            document.body.style.color = text;
                            customModal.remove();
                        };
                    }
                    customModal.style.display = 'flex';
                }
            };

            // Language select logic
            const languageSelect = settingsModal.querySelector('#languageSelect');
            languageSelect.value = localStorage.getItem('omniwrite-lang') || 'en';
            languageSelect.onchange = function () {
                localStorage.setItem('omniwrite-lang', this.value);
                showToast('Language updated.', { type: 'success' });
                applyTranslations(this.value);
                setTimeout(() => {
                    if (document.getElementById('templatesList')) renderTemplatesList();
                    if (document.getElementById('documentsList')) {
                        document.getElementById('documentsList').innerHTML = '';
                        documents.forEach(doc => addDocumentToList(doc));
                    }
                }, 100);
            };

            // Simple translation dictionary for UI text
            const TRANSLATIONS = {
                en: {
                    'Welcome to Munetios OmniWrite': 'Welcome to Munetios OmniWrite',
                    'Select or create a new document to get started.': 'Select or create a new document to get started.',
                    'Images': 'Images',
                    'Tasks': 'Tasks',
                    'Templates': 'Templates',
                    'Settings': 'Settings',
                    'Help': 'Help',
                    'New Document': 'New Document',
                    'New Image': 'New Image',
                    'Import File': 'Import File',
                    'Upload Image': 'Upload Image',
                    'Download': 'Download',
                    'Make a Copy': 'Make a Copy',
                    'Compare Documents': 'Compare Documents',
                    'Share': 'Share',
                    'Delete': 'Delete',
                    'Rename Document': 'Rename Document',
                    'Version History': 'Version History',
                    'Table of Contents': 'Table of Contents',
                    'No Images': 'No Images',
                    'Trash is empty': 'Trash is empty',
                    'View Trash': 'View Trash',
                    'Back to Images': 'Back to Images',
                    'Theme:': 'Theme:',
                    'Language:': 'Language:',
                    'Backup & Restore': 'Backup & Restore',
                    'Export Backup': 'Export Backup',
                    'Import Backup': 'Import Backup',
                    'Danger Zone': 'Danger Zone',
                    'Reset Encryption Key': 'Reset Encryption Key',
                    'Delete Everything': 'Delete Everything',
                    'Delete Document': 'Delete Document',
                    'Are you sure you want to delete this document? This cannot be undone.': 'Are you sure you want to delete this document? This cannot be undone.',
                    'Cancel': 'Cancel',
                    'Restore This Version': 'Restore This Version',
                    'Share this document with others by downloading it as a PDF file.': 'Share this document with others by downloading it as a PDF file.',
                    'Download as PDF': 'Download as PDF',
                    'Download a PDF version of this document.': 'Download a PDF version of this document.',
                    'No versions saved yet.': 'No versions saved yet.',
                    'No headings found to build Table of Contents.': 'No headings found to build Table of Contents.',
                    'File imported.': 'File imported.',
                    'Image inserted and added to library.': 'Image inserted and added to library.',
                    'Image uploaded and added to library.': 'Image uploaded and added to library.',
                    'Document duplicated.': 'Document duplicated.',
                    'Document deleted.': 'Document deleted.',
                    'Backup exported.': 'Backup exported.',
                    'Backup imported.': 'Backup imported.',
                    'Invalid backup file.': 'Invalid backup file.',
                    'Failed to import backup.': 'Failed to import backup.',
                    'Encryption key reset. All documents deleted.': 'Encryption key reset. All documents deleted.',
                    'All data deleted.': 'All data deleted.',
                    'Theme updated.': 'Theme updated.',
                    'Language updated.': 'Language updated.',
                    'Print dialog opened. Choose "Save as PDF" to download.': 'Print dialog opened. Choose "Save as PDF" to download.',
                    'Document downloaded as HTML.': 'Document downloaded as HTML.',
                    'Unsupported file type.': 'Unsupported file type.',
                    'Failed to import DOCX.': 'Failed to import DOCX.',
                    'Importing DOCX...': 'Importing DOCX...',
                    'Please enter a valid image URL.': 'Please enter a valid image URL.',
                },
                es: {
                    'Welcome to Munetios OmniWrite': 'Bienvenido a Munetios OmniWrite',
                    'Select or create a new document to get started.': 'Seleccione o cree un nuevo documento para comenzar.',
                    'Images': 'Imgenes',
                    'Tasks': 'Tareas',
                    'Templates': 'Plantillas',
                    'Settings': 'Configuracin',
                    'Help': 'Ayuda',
                    'New Document': 'Nuevo Documento',
                    'New Image': 'Nueva Imagen',
                    'Import File': 'Importar Archivo',
                    'Upload Image': 'Subir Imagen',
                    'Download': 'Descargar',
                    'Make a Copy': 'Hacer una copia',
                    'Compare Documents': 'Comparar Documentos',
                    'Share': 'Compartir',
                    'Delete': 'Eliminar',
                    'Rename Document': 'Renombrar Documento',
                    'Version History': 'Historial de Versiones',
                    'Table of Contents': 'Tabla de Contenidos',
                    'No Images': 'Sin Imgenes',
                    'Trash is empty': 'La papelera est vaca',
                    'View Trash': 'Ver Papelera',
                    'Back to Images': 'Volver a Imgenes',
                    'Theme:': 'Tema:',
                    'Language:': 'Idioma:',
                    'Backup & Restore': 'Respaldo y Restauracin',
                    'Export Backup': 'Exportar Respaldo',
                    'Import Backup': 'Importar Respaldo',
                    'Danger Zone': 'Zona de Peligro',
                    'Reset Encryption Key': 'Restablecer Clave de Encriptacin',
                    'Delete Everything': 'Eliminar Todo',
                    'Delete Document': 'Eliminar Documento',
                    'Are you sure you want to delete this document? This cannot be undone.': 'Est seguro de que desea eliminar este documento? Esto no se puede deshacer.',
                    'Cancel': 'Cancelar',
                    'Restore This Version': 'Restaurar Esta Versin',
                    'Share this document with others by downloading it as a PDF file.': 'Comparta este documento con otros descargndolo como archivo PDF.',
                    'Download as PDF': 'Descargar como PDF',
                    'Download a PDF version of this document.': 'Descargue una versin PDF de este documento.',
                    'No versions saved yet.': 'No hay versiones guardadas an.',
                    'No headings found to build Table of Contents.': 'No se encontraron encabezados para construir la tabla de contenidos.',
                    'File imported.': 'Archivo importado.',
                    'Image inserted and added to library.': 'Imagen insertada y agregada a la biblioteca.',
                    'Image uploaded and added to library.': 'Imagen subida y agregada a la biblioteca.',
                    'Document duplicated.': 'Documento duplicado.',
                    'Document deleted.': 'Documento eliminado.',
                    'Backup exported.': 'Respaldo exportado.',
                    'Backup imported.': 'Respaldo importado.',
                    'Invalid backup file.': 'Archivo de respaldo invlido.',
                    'Failed to import backup.': 'Error al importar respaldo.',
                    'Encryption key reset. All documents deleted.': 'Clave de encriptacin restablecida. Todos los documentos eliminados.',
                    'All data deleted.': 'Todos los datos eliminados.',
                    'Theme updated.': 'Tema actualizado.',
                    'Language updated.': 'Idioma actualizado.',
                    'Print dialog opened. Choose "Save as PDF" to download.': 'Dilogo de impresin abierto. Elija "Guardar como PDF" para descargar.',
                    'Document downloaded as HTML.': 'Documento descargado como HTML.',
                    'Unsupported file type.': 'Tipo de archivo no soportado.',
                    'Failed to import DOCX.': 'Error al importar DOCX.',
                    'Importing DOCX...': 'Importando DOCX...',
                    'Please enter a valid image URL.': 'Por favor, ingrese una URL de imagen vlida.',
                },
                // Add more languages here (fr, de, zh, ja, etc.)
            fr: {
                'Welcome to Munetios OmniWrite': 'Bienvenue sur Munetios OmniWrite',
                'Select or create a new document to get started.': 'Slectionnez ou crez un nouveau document pour commencer.',
                'Images': 'Images',
                'Tasks': 'Tches',
                'Templates': 'Modles',
                'Settings': 'Paramtres',
                'Help': 'Aide',
                'New Document': 'Nouveau Document',
                'New Image': 'Nouvelle Image',
                'Import File': 'Importer un fichier',
                'Upload Image': 'Tlcharger une image',
                'Download': 'Tlcharger',
                'Make a Copy': 'Faire une copie',
                'Compare Documents': 'Comparer les documents',
                'Share': 'Partager',
                'Delete': 'Supprimer',
                'Rename Document': 'Renommer le document',
                'Version History': 'Historique des versions',
                'Table of Contents': 'Table des matires',
                'No Images': 'Aucune image',
                'Trash is empty': 'La corbeille est vide',
                'View Trash': 'Voir la corbeille',
                'Back to Images': 'Retour aux images',
                'Theme:': 'Thme :',
                'Language:': 'Langue :',
                'Backup & Restore': 'Sauvegarde et restauration',
                'Export Backup': 'Exporter la sauvegarde',
                'Import Backup': 'Importer la sauvegarde',
                'Danger Zone': 'Zone dangereuse',
                'Reset Encryption Key': 'Rinitialiser la cl de chiffrement',
                'Delete Everything': 'Tout supprimer',
                'Delete Document': 'Supprimer le document',
                'Are you sure you want to delete this document? This cannot be undone.': 'tes-vous sr de vouloir supprimer ce document ? Cette action est irrversible.',
                'Cancel': 'Annuler',
                'Restore This Version': 'Restaurer cette version',
                'Share this document with others by downloading it as a PDF file.': 'Partagez ce document en le tlchargeant au format PDF.',
                'Download as PDF': 'Tlcharger en PDF',
                'Download a PDF version of this document.': 'Tlchargez une version PDF de ce document.',
                'No versions saved yet.': 'Aucune version enregistre.',
                'No headings found to build Table of Contents.': 'Aucun titre trouv pour crer la table des matires.',
                'File imported.': 'Fichier import.',
                'Image inserted and added to library.': 'Image insre et ajoute  la bibliothque.',
                'Image uploaded and added to library.': 'Image tlcharge et ajoute  la bibliothque.',
                'Document duplicated.': 'Document dupliqu.',
                'Document deleted.': 'Document supprim.',
                'Backup exported.': 'Sauvegarde exporte.',
                'Backup imported.': 'Sauvegarde importe.',
                'Invalid backup file.': 'Fichier de sauvegarde invalide.',
                'Failed to import backup.': 'chec de l\'importation de la sauvegarde.',
                'Encryption key reset. All documents deleted.': 'Cl de chiffrement rinitialise. Tous les documents ont t supprims.',
                'All data deleted.': 'Toutes les donnes ont t supprimes.',
                'Theme updated.': 'Thme mis  jour.',
                'Language updated.': 'Langue mise  jour.',
                'Print dialog opened. Choose "Save as PDF" to download.': 'Dialogue d\'impression ouvert. Choisissez "Enregistrer en PDF" pour tlcharger.',
                'Document downloaded as HTML.': 'Document tlcharg en HTML.',
                'Unsupported file type.': 'Type de fichier non pris en charge.',
                'Failed to import DOCX.': 'chec de l\'importation du DOCX.',
                'Importing DOCX...': 'Importation du DOCX...',
                'Please enter a valid image URL.': 'Veuillez entrer une URL d\'image valide.',
            },
            de: {
                'Welcome to Munetios OmniWrite': 'Willkommen bei Munetios OmniWrite',
                'Select or create a new document to get started.': 'Whlen Sie ein Dokument aus oder erstellen Sie ein neues, um zu beginnen.',
                'Images': 'Bilder',
                'Tasks': 'Aufgaben',
                'Templates': 'Vorlagen',
                'Settings': 'Einstellungen',
                'Help': 'Hilfe',
                'New Document': 'Neues Dokument',
                'New Image': 'Neues Bild',
                'Import File': 'Datei importieren',
                'Upload Image': 'Bild hochladen',
                'Download': 'Herunterladen',
                'Make a Copy': 'Kopie erstellen',
                'Compare Documents': 'Dokumente vergleichen',
                'Share': 'Teilen',
                'Delete': 'Lschen',
                'Rename Document': 'Dokument umbenennen',
                'Version History': 'Versionsverlauf',
                'Table of Contents': 'Inhaltsverzeichnis',
                'No Images': 'Keine Bilder',
                'Trash is empty': 'Papierkorb ist leer',
                'View Trash': 'Papierkorb anzeigen',
                'Back to Images': 'Zurck zu Bildern',
                'Theme:': 'Thema:',
                'Language:': 'Sprache:',
                'Backup & Restore': 'Backup & Wiederherstellung',
                'Export Backup': 'Backup exportieren',
                'Import Backup': 'Backup importieren',
                'Danger Zone': 'Gefahrenzone',
                'Reset Encryption Key': 'Verschlsselungsschlssel zurcksetzen',
                'Delete Everything': 'Alles lschen',
                'Delete Document': 'Dokument lschen',
                'Are you sure you want to delete this document? This cannot be undone.': 'Sind Sie sicher, dass Sie dieses Dokument lschen mchten? Dies kann nicht rckgngig gemacht werden.',
                'Cancel': 'Abbrechen',
                'Restore This Version': 'Diese Version wiederherstellen',
                'Share this document with others by downloading it as a PDF file.': 'Teilen Sie dieses Dokument, indem Sie es als PDF herunterladen.',
                'Download as PDF': 'Als PDF herunterladen',
                'Download a PDF version of this document.': 'Laden Sie eine PDF-Version dieses Dokuments herunter.',
                'No versions saved yet.': 'Noch keine Versionen gespeichert.',
                'No headings found to build Table of Contents.': 'Keine berschriften fr das Inhaltsverzeichnis gefunden.',
                'File imported.': 'Datei importiert.',
                'Image inserted and added to library.': 'Bild eingefgt und zur Bibliothek hinzugefgt.',
                'Image uploaded and added to library.': 'Bild hochgeladen und zur Bibliothek hinzugefgt.',
                'Document duplicated.': 'Dokument dupliziert.',
                'Document deleted.': 'Dokument gelscht.',
                'Backup exported.': 'Backup exportiert.',
                'Backup imported.': 'Backup importiert.',
                'Invalid backup file.': 'Ungltige Backup-Datei.',
                'Failed to import backup.': 'Backup konnte nicht importiert werden.',
                'Encryption key reset. All documents deleted.': 'Verschlsselungsschlssel zurckgesetzt. Alle Dokumente gelscht.',
                'All data deleted.': 'Alle Daten gelscht.',
                'Theme updated.': 'Thema aktualisiert.',
                'Language updated.': 'Sprache aktualisiert.',
                'Print dialog opened. Choose "Save as PDF" to download.': 'Druckdialog geffnet. Whlen Sie "Als PDF speichern" zum Herunterladen.',
                'Document downloaded as HTML.': 'Dokument als HTML heruntergeladen.',
                'Unsupported file type.': 'Nicht untersttzter Dateityp.',
                'Failed to import DOCX.': 'DOCX konnte nicht importiert werden.',
                'Importing DOCX...': 'DOCX wird importiert...',
                'Please enter a valid image URL.': 'Bitte geben Sie eine gltige Bild-URL ein.',
            },
            zh: {
                'Welcome to Munetios OmniWrite': ' Munetios OmniWrite',
                'Select or create a new document to get started.': '',
                'Images': '',
                'Tasks': '',
                'Templates': '',
                'Settings': '',
                'Help': '',
                'New Document': '',
                'New Image': '',
                'Import File': '',
                'Upload Image': '',
                'Download': '',
                'Make a Copy': '',
                'Compare Documents': '',
                'Share': '',
                'Delete': '',
                'Rename Document': '',
                'Version History': '',
                'Table of Contents': '',
                'No Images': '',
                'Trash is empty': '',
                'View Trash': '',
                'Back to Images': '',
                'Theme:': '',
                'Language:': '',
                'Backup & Restore': '',
                'Export Backup': '',
                'Import Backup': '',
                'Danger Zone': '',
                'Reset Encryption Key': '',
                'Delete Everything': '',
                'Delete Document': '',
                'Are you sure you want to delete this document? This cannot be undone.': '',
                'Cancel': '',
                'Restore This Version': '',
                'Share this document with others by downloading it as a PDF file.': ' PDF ',
                'Download as PDF': ' PDF',
                'Download a PDF version of this document.': ' PDF ',
                'No versions saved yet.': '',
                'No headings found to build Table of Contents.': '',
                'File imported.': '',
                'Image inserted and added to library.': '',
                'Image uploaded and added to library.': '',
                'Document duplicated.': '',
                'Document deleted.': '',
                'Backup exported.': '',
                'Backup imported.': '',
                'Invalid backup file.': '',
                'Failed to import backup.': '',
                'Encryption key reset. All documents deleted.': '',
                'All data deleted.': '',
                'Theme updated.': '',
                'Language updated.': '',
                'Print dialog opened. Choose "Save as PDF" to download.': ' PDF',
                'Document downloaded as HTML.': ' HTML',
                'Unsupported file type.': '',
                'Failed to import DOCX.': 'DOCX ',
                'Importing DOCX...': ' DOCX...',
                'Please enter a valid image URL.': '',
            },
            ja: {
                'Welcome to Munetios OmniWrite': 'Munetios OmniWrite ',
                'Select or create a new document to get started.': '',
                'Images': '',
                'Tasks': '',
                'Templates': '',
                'Settings': '',
                'Help': '',
                'New Document': '',
                'New Image': '',
                'Import File': '',
                'Upload Image': '',
                'Download': '',
                'Make a Copy': '',
                'Compare Documents': '',
                'Share': '',
                'Delete': '',
                'Rename Document': '',
                'Version History': '',
                'Table of Contents': '',
                'No Images': '',
                'Trash is empty': '',
                'View Trash': '',
                'Back to Images': '',
                'Theme:': '',
                'Language:': '',
                'Backup & Restore': '',
                'Export Backup': '',
                'Import Backup': '',
                'Danger Zone': '',
                'Reset Encryption Key': '',
                'Delete Everything': '',
                'Delete Document': '',
                'Are you sure you want to delete this document? This cannot be undone.': '',
                'Cancel': '',
                'Restore This Version': '',
                'Share this document with others by downloading it as a PDF file.': 'PDF',
                'Download as PDF': 'PDF',
                'Download a PDF version of this document.': 'PDF',
                'No versions saved yet.': '',
                'No headings found to build Table of Contents.': '',
                'File imported.': '',
                'Image inserted and added to library.': '',
                'Image uploaded and added to library.': '',
                'Document duplicated.': '',
                'Document deleted.': '',
                'Backup exported.': '',
                'Backup imported.': '',
                'Invalid backup file.': '',
                'Failed to import backup.': '',
                'Encryption key reset. All documents deleted.': '',
                'All data deleted.': '',
                'Theme updated.': '',
                'Language updated.': '',
                'Print dialog opened. Choose "Save as PDF" to download.': 'PDF',
                'Document downloaded as HTML.': 'HTML',
                'Unsupported file type.': '',
                'Failed to import DOCX.': 'DOCX',
                'Importing DOCX...': 'DOCX...',
                'Please enter a valid image URL.': 'URL',
            },
            };

            function applyTranslations(lang) {
                const dict = TRANSLATIONS[lang] || TRANSLATIONS['en'];
                // Translate static text elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (dict[key]) el.textContent = dict[key];
                });
                // Translate sidebar menu
                document.querySelectorAll('.sidebarnav__item .menu-text').forEach(el => {
                    if (dict[el.textContent]) el.textContent = dict[el.textContent];
                });
                // Translate create options
                document.querySelectorAll('#createOptions .menu-text').forEach(el => {
                    if (dict[el.textContent]) el.textContent = dict[el.textContent];
                });
                // Translate settings modal labels
                document.querySelectorAll('.modal-content label, .modal-content b, .modal-content h2, .modal-content h3, .modal-content h1, .modal-content h4, .modal-content h5, .modal-content h6').forEach(el => {
                    if (dict[el.textContent]) el.textContent = dict[el.textContent];
                });
                // Translate buttons
                document.querySelectorAll('button, .modal-content-close').forEach(el => {
                    if (dict[el.textContent]) el.textContent = dict[el.textContent];
                });
                // Translate toast messages (patch showToast)
                window.showToast = function(message, options = {}) {
                    const msg = dict[message] || message;
                    // Remove any existing toast
                    const old = document.getElementById('omniwrite-toast');
                    if (old) old.remove();
                    const toast = document.createElement('div');
                    toast.id = 'omniwrite-toast';
                    toast.className = 'liquid-glass';
                    toast.textContent = msg;
                    toast.style.position = 'fixed';
                    toast.style.left = '50%';
                    toast.style.bottom = '40px';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.padding = '14px 32px';
                    toast.style.fontSize = '16px';
                    toast.style.zIndex = 999999;
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.2s';
                    let bg = 'rgba(30,30,40,0.92)';
                    let color = '#fff';
                    if (options.type === 'success') {
                        bg = 'rgba(46, 204, 113, 0.88)';
                        color = '#fff';
                    } else if (options.type === 'error') {
                        bg = 'rgba(231, 76, 60, 0.88)';
                        color = '#fff';
                    } else if (options.type === 'info') {
                        bg = 'rgba(52, 152, 219, 0.88)';
                        color = '#fff';
                    }
                    toast.style.background = bg;
                    toast.style.color = color;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.opacity = '1';
                    }, 10);
                    const duration = typeof options.duration === 'number' ? options.duration : 2600;
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                };
            }

            // On load, apply translations
            applyTranslations(languageSelect.value);

            // Export backup
            settingsModal.querySelector('#exportBackupBtn').onclick = async function () {
                // Export all documents as JSON
                const backup = {
                    documents: documents,
                    time: Date.now()
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'omniwrite-backup-' + new Date().toISOString().replace(/[:.]/g, '-') + '.json';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    URL.revokeObjectURL(a.href);
                    a.remove();
                }, 100);
                showToast('Backup exported.', { type: 'success' });
            };

            // Import backup
            const importInput = settingsModal.querySelector('#importBackupInput');
            settingsModal.querySelector('#importBackupBtn').onclick = function () {
                importInput.click();
            };
            importInput.onchange = async function (e) {
                const file = importInput.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async function (ev) {
                    try {
                        const backup = JSON.parse(ev.target.result);
                        if (Array.isArray(backup.documents)) {
                            // Replace all documents
                            documents = backup.documents;
                            // Save to IndexedDB
                            await saveDocuments();
                            // Refresh sidebar
                            const list = document.getElementById('documentsList');
                            list.innerHTML = '';
                            documents.forEach(doc => addDocumentToList(doc));
                            showToast('Backup imported.', { type: 'success' });
                        } else {
                            showToast('Invalid backup file.', { type: 'error' });
                        }
                    } catch (err) {
                        showToast('Failed to import backup.', { type: 'error' });
                    }
                };
                reader.readAsText(file);
            };

            // Danger Zone: Reset Encryption Key
            settingsModal.querySelector('#resetKeyBtn').onclick = async function () {
                // Use a custom modal for confirmation since window.confirm is patched
                let confirmModal = document.createElement('div');
                confirmModal.className = 'modal';
                confirmModal.innerHTML = `
                    <div class="modal-content" style="position:relative;max-width:340px;">
                        <span class="modal-content-close" id="closeResetKeyModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                        <h2>Reset Encryption Key</h2>
                        <p>Resetting the encryption key will make all existing documents unreadable. Continue?</p>
                        <div style="margin-top:18px;display:flex;gap:12px;">
                            <button id="confirmResetKeyBtn" style="background:#ffe066;color:#110736;">Reset Key</button>
                            <button id="cancelResetKeyBtn">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
                confirmModal.querySelector('#closeResetKeyModal').onclick = () => confirmModal.remove();
                confirmModal.querySelector('#cancelResetKeyBtn').onclick = () => confirmModal.remove();
                confirmModal.querySelector('#confirmResetKeyBtn').onclick = async function () {
                    // Delete key from IndexedDB
                    const tx = db.transaction(KEY_STORE, 'readwrite');
                    tx.objectStore(KEY_STORE).delete('main');
                    // Clear all documents
                    documents = [];
                    const docTx = db.transaction(DOC_STORE, 'readwrite');
                    docTx.objectStore(DOC_STORE).clear();
                    showToast('Encryption key reset. All documents deleted.', { type: 'success' });
                    confirmModal.remove();
                    setTimeout(() => window.location.reload(), 1200);
                };
            };
            
            // Danger Zone: Delete Everything
            settingsModal.querySelector('#deleteEverythingBtn').onclick = async function () {
                // Use a custom modal for confirmation since window.confirm is patched
                let confirmModal = document.createElement('div');
                confirmModal.className = 'modal';
                confirmModal.innerHTML = `
                    <div class="modal-content" style="position:relative;max-width:340px;">
                        <span class="modal-content-close" id="closeDeleteAllModal" style="position:absolute;top:12px;right:18px;cursor:pointer;font-size:22px;">&times;</span>
                        <h2>Delete Everything</h2>
                        <p>Delete all documents and images? This cannot be undone.</p>
                        <div style="margin-top:18px;display:flex;gap:12px;">
                            <button id="confirmDeleteAllBtn" style="background:#e74c3c;color:#fff;">Delete All</button>
                            <button id="cancelDeleteAllBtn">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
                confirmModal.querySelector('#closeDeleteAllModal').onclick = () => confirmModal.remove();
                confirmModal.querySelector('#cancelDeleteAllBtn').onclick = () => confirmModal.remove();
                confirmModal.querySelector('#confirmDeleteAllBtn').onclick = async function () {
                    documents = [];
                    // Clear all stores using transactions
                    await Promise.all([
                        new Promise(res => {
                            const tx = db.transaction(DOC_STORE, 'readwrite');
                            tx.objectStore(DOC_STORE).clear();
                            tx.oncomplete = res;
                        }),
                        new Promise(res => {
                            const tx = db.transaction(IMAGE_STORE, 'readwrite');
                            tx.objectStore(IMAGE_STORE).clear();
                            tx.oncomplete = res;
                        }),
                        new Promise(res => {
                            const tx = db.transaction(TRASH_STORE, 'readwrite');
                            tx.objectStore(TRASH_STORE).clear();
                            tx.oncomplete = res;
                        }),
                        new Promise(res => {
                            const tx = db.transaction(KEY_STORE, 'readwrite');
                            tx.objectStore(KEY_STORE).clear();
                            tx.oncomplete = res;
                        })
                    ]);
                    document.getElementById('documentsList').innerHTML = '';
                    showToast('All data deleted.', { type: 'success' });
                    confirmModal.remove();
                    setTimeout(() => window.location.reload(), 1200);
                };
            };
        });
        // --- Block all confirm(), alert(), and prompt() globally ---
        window.alert = function(msg) { showToast(String(msg), { type: 'info' }); };
        window.confirm = function() { return false; };
        window.prompt = function() { return null; };

        //
    </script>
</body>
</html>